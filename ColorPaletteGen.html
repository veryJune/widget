<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChromaZen - Pro Color Tool v3.5</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Tailwind Config for Dark Mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#121212',
                            surface: '#1E1E1E',
                            border: '#333333',
                            text: '#EDEDED',
                            muted: '#A1A1AA'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #F5F5F7;
            color: #1D1D1F;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark {
            background-color: #121212;
            color: #EDEDED;
        }

        /* Custom Slider */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #FFFFFF;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 1px solid rgba(0,0,0,0.1);
        }

        .dark input[type=range]::-webkit-slider-thumb {
            background: #333;
            border-color: #555;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #E5E5E5;
            border-radius: 2px;
        }

        .dark input[type=range]::-webkit-slider-runnable-track {
            background: #333;
        }

        /* Color Panel Transition */
        .color-panel {
            transition: background-color 0.5s cubic-bezier(0.2, 0.8, 0.2, 1), flex 0.3s ease;
        }

        .panel-dragging {
            opacity: 0.5;
            transform: scale(0.95);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            z-index: 50;
        }

        /* Toast */
        #toast {
            backdrop-filter: blur(12px);
            background: rgba(30, 30, 30, 0.9);
            color: white;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }

        /* Modal Overlay */
        .modal-backdrop {
            backdrop-filter: blur(5px);
            background: rgba(0,0,0,0.4);
        }
        .dark .modal-backdrop {
            background: rgba(0,0,0,0.7);
        }

        .mono-font {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Scrollbar */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #E5E5E5;
            border-radius: 3px;
        }
        .dark .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #333;
        }

        /* Noise Texture */
        .noise-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.05;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='1'/%3E%3C/svg%3E");
            display: none;
        }

        /* Button Animation */
        @keyframes pop {
            0% { transform: scale(1); }
            40% { transform: scale(0.95); }
            70% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .btn-pop {
            animation: pop 0.3s ease-in-out;
        }

        /* Particles */
        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            animation: particle-fade 0.8s ease-out forwards;
        }
        @keyframes particle-fade {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col overflow-hidden select-none transition-colors duration-300">

    <!-- Noise Overlay -->
    <div id="noise-layer" class="noise-overlay"></div>

    <!-- Top Bar -->
    <header class="h-16 flex items-center justify-between px-4 md:px-6 bg-white dark:bg-dark-surface border-b border-gray-200 dark:border-dark-border z-20 shadow-sm shrink-0 transition-colors duration-300">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-white shadow-md">
                <i data-lucide="palette" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-base md:text-lg font-bold tracking-tight text-gray-900 dark:text-white leading-none">ChromaZen</h1>
                <span class="text-[10px] font-medium text-gray-400 dark:text-gray-500">Pro Color Tool v3.5</span>
            </div>
        </div>
        
        <div class="flex items-center gap-2 md:gap-4">
            
             <!-- Undo/Redo (Desktop) -->
            <div class="hidden md:flex items-center bg-gray-100 dark:bg-dark-bg p-1 rounded-lg border dark:border-dark-border">
                <button onclick="undo()" class="p-1.5 rounded hover:bg-white dark:hover:bg-dark-surface hover:shadow-sm text-gray-500 dark:text-gray-400 transition-all" title="Undo (Ctrl+Z)">
                    <i data-lucide="undo-2" class="w-4 h-4"></i>
                </button>
                <div class="w-px h-4 bg-gray-300 dark:bg-dark-border mx-1"></div>
                <button onclick="redo()" class="p-1.5 rounded hover:bg-white dark:hover:bg-dark-surface hover:shadow-sm text-gray-500 dark:text-gray-400 transition-all" title="Redo (Ctrl+Y)">
                    <i data-lucide="redo-2" class="w-4 h-4"></i>
                </button>
            </div>

            <!-- View Modes -->
            <div class="hidden md:flex bg-gray-100 dark:bg-dark-bg p-1 rounded-lg border dark:border-dark-border">
                <button onclick="setViewMode('palette')" id="view-palette" class="px-3 py-1.5 text-xs font-semibold rounded-md shadow-sm bg-white dark:bg-dark-surface text-gray-900 dark:text-white transition-all flex items-center gap-1.5">
                    <i data-lucide="columns" class="w-3 h-3"></i> Palette
                </button>
                <button onclick="setViewMode('gradient')" id="view-gradient" class="px-3 py-1.5 text-xs font-semibold rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-all flex items-center gap-1.5">
                    <i data-lucide="activity" class="w-3 h-3"></i> Gradient
                </button>
                <button onclick="setViewMode('mockup')" id="view-mockup" class="px-3 py-1.5 text-xs font-semibold rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition-all flex items-center gap-1.5">
                    <i data-lucide="layout-template" class="w-3 h-3"></i> Mockup
                </button>
            </div>

            <div class="h-6 w-px bg-gray-200 dark:bg-dark-border hidden md:block"></div>

            <!-- Analyze Contrast -->
            <button onclick="showContrastModal()" class="hidden md:flex px-3 py-1.5 text-xs font-medium rounded-md border border-gray-300 dark:border-dark-border text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-bg transition-colors items-center gap-1.5">
                <i data-lucide="eye" class="w-3 h-3"></i> Analyze
            </button>

            <!-- Export -->
            <div class="relative group z-50">
                <button class="px-3 py-1.5 text-xs font-medium rounded-md border border-gray-300 dark:border-dark-border text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-dark-bg transition-colors flex items-center gap-1.5">
                    <i data-lucide="download" class="w-3 h-3"></i> Export
                </button>
                <div class="absolute right-0 mt-2 w-48 bg-white dark:bg-dark-surface rounded-xl shadow-xl border border-gray-100 dark:border-dark-border hidden group-hover:block p-1 z-50">
                    <button onclick="exportImage()" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-50 dark:hover:bg-dark-bg dark:text-gray-200 rounded-lg flex items-center gap-2">
                        <i data-lucide="image" class="w-3 h-3 text-pink-500"></i> Image (PNG)
                    </button>
                    <button onclick="showCSSModal()" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-50 dark:hover:bg-dark-bg dark:text-gray-200 rounded-lg flex items-center gap-2">
                        <i data-lucide="code" class="w-3 h-3 text-blue-500"></i> CSS Code
                    </button>
                    <button onclick="downloadASE()" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-50 dark:hover:bg-dark-bg dark:text-gray-200 rounded-lg flex items-center gap-2">
                        <i data-lucide="file-box" class="w-3 h-3 text-purple-500"></i> Adobe ASE
                    </button>
                </div>
            </div>

            <!-- Dark Mode Toggle -->
            <button onclick="toggleDarkMode()" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-dark-bg text-gray-500 dark:text-yellow-400 transition-colors">
                <i data-lucide="sun" class="w-4 h-4 dark:hidden"></i>
                <i data-lucide="moon" class="w-4 h-4 hidden dark:block"></i>
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-1 flex flex-col md:flex-row relative overflow-hidden bg-gray-50 dark:bg-dark-bg transition-colors duration-300">
        
        <!-- Controls Sidebar -->
        <aside class="w-full md:w-80 bg-white dark:bg-dark-surface border-r border-gray-200 dark:border-dark-border p-5 flex flex-col gap-6 z-10 overflow-y-auto scrollbar-thin shrink-0 transition-colors duration-300">
            
            <!-- Generate & Count -->
            <div class="space-y-3">
                <div class="flex bg-gray-100 dark:bg-dark-bg p-1 rounded-lg w-full border dark:border-dark-border">
                    <button id="mode2" class="flex-1 py-1.5 text-xs font-semibold rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-900" onclick="setMode(2)">2</button>
                    <button id="mode3" class="flex-1 py-1.5 text-xs font-semibold rounded-md shadow-sm bg-white dark:bg-dark-surface text-gray-900 dark:text-white" onclick="setMode(3)">3</button>
                    <button id="mode4" class="flex-1 py-1.5 text-xs font-semibold rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-900" onclick="setMode(4)">4</button>
                    <button id="mode5" class="flex-1 py-1.5 text-xs font-semibold rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-900" onclick="setMode(5)">5</button>
                </div>

                <div class="relative w-full">
                    <button id="btn-generate" onclick="generatePalette()" class="w-full py-3.5 bg-black dark:bg-white dark:text-black text-white rounded-xl text-base font-semibold shadow-lg hover:bg-gray-800 dark:hover:bg-gray-200 active:scale-95 transition-all flex items-center justify-center gap-2 group relative overflow-hidden">
                        <i data-lucide="shuffle" class="w-4 h-4 group-hover:rotate-180 transition-transform duration-500"></i>
                        <span>Generate</span>
                    </button>
                    <!-- Particles Container -->
                    <div id="particle-container" class="absolute top-1/2 left-1/2 w-0 h-0 pointer-events-none"></div>
                </div>
            </div>

            <!-- Harmony Rules -->
            <div class="space-y-2">
                <label class="text-[10px] font-bold text-gray-400 dark:text-dark-muted uppercase tracking-wider">Harmony Rule</label>
                <div class="relative">
                    <select id="harmony-select" onchange="generatePalette()" class="w-full appearance-none bg-gray-50 dark:bg-dark-bg border border-gray-200 dark:border-dark-border text-gray-700 dark:text-gray-200 py-2.5 px-3 pr-8 rounded-lg text-xs font-medium focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <option value="random">üé≤ Random Shuffle</option>
                        <option value="analogous">üé® Analogous (Ïú†ÏÇ¨ÏÉâ)</option>
                        <option value="monochromatic">üåó Monochromatic (Îã®ÏÉâ)</option>
                        <option value="complementary">‚òØÔ∏è Complementary (Î≥¥ÏÉâ)</option>
                        <option value="triadic">üî∫ Triadic (ÏÇºÍ∞ÅÏ°∞Ìôî)</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </div>
                </div>
            </div>

            <!-- Presets Grid -->
            <div class="space-y-2">
                <label class="text-[10px] font-bold text-gray-400 dark:text-dark-muted uppercase tracking-wider">Style Presets</label>
                <!-- UI FIX: Increased padding and removed potential overflow clip -->
                <div class="grid grid-cols-2 gap-2 h-64 overflow-y-auto px-1 py-1 scrollbar-thin">
                    <button onclick="setPreset('corporate')" class="preset-btn py-2 px-3 rounded-lg border border-gray-100 dark:border-dark-border bg-gray-50 dark:bg-dark-bg hover:bg-white dark:hover:bg-dark-surface hover:border-gray-300 transition-all text-left flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-slate-600 shrink-0"></span> <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Corporate</span>
                    </button>
                    <button onclick="setPreset('luxury')" class="preset-btn py-2 px-3 rounded-lg border border-gray-100 dark:border-dark-border bg-gray-50 dark:bg-dark-bg hover:bg-white dark:hover:bg-dark-surface hover:border-gray-300 transition-all text-left flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-yellow-600 shrink-0"></span> <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Luxury</span>
                    </button>
                    <button onclick="setPreset('pop')" class="preset-btn py-2 px-3 rounded-lg border border-gray-100 dark:border-dark-border bg-gray-50 dark:bg-dark-bg hover:bg-white dark:hover:bg-dark-surface hover:border-gray-300 transition-all text-left flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-red-500 shrink-0"></span> <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Pop/Playful</span>
                    </button>
                    <button onclick="setPreset('wedding')" class="preset-btn py-2 px-3 rounded-lg border border-gray-100 dark:border-dark-border bg-gray-50 dark:bg-dark-bg hover:bg-white dark:hover:bg-dark-surface hover:border-gray-300 transition-all text-left flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-pink-100 border border-gray-200 shrink-0"></span> <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Wedding</span>
                    </button>
                    <button onclick="setPreset('vivid')" class="preset-btn py-2 px-3 rounded-lg border border-gray-100 dark:border-dark-border bg-gray-50 dark:bg-dark-bg hover:bg-white dark:hover:bg-dark-surface hover:border-gray-300 transition-all text-left flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-blue-600 shrink-0"></span> <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Vivid</span>
                    </button>
                    <button onclick="setPreset('pastel')" class="preset-btn py-2 px-3 rounded-lg border border-gray-100 dark:border-dark-border bg-gray-50 dark:bg-dark-bg hover:bg-white dark:hover:bg-dark-surface hover:border-gray-300 transition-all text-left flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-pink-200 shrink-0"></span> <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Pastel</span>
                    </button>
                    <button onclick="setPreset('dark')" class="preset-btn py-2 px-3 rounded-lg border border-gray-100 dark:border-dark-border bg-gray-50 dark:bg-dark-bg hover:bg-white dark:hover:bg-dark-surface hover:border-gray-300 transition-all text-left flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-gray-800 shrink-0"></span> <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Dark</span>
                    </button>
                    <button onclick="setPreset('warm')" class="preset-btn py-2 px-3 rounded-lg border border-gray-100 dark:border-dark-border bg-gray-50 dark:bg-dark-bg hover:bg-white dark:hover:bg-dark-surface hover:border-gray-300 transition-all text-left flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-orange-400 shrink-0"></span> <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Warm</span>
                    </button>
                    <button onclick="setPreset('nature')" class="preset-btn py-2 px-3 rounded-lg border border-gray-100 dark:border-dark-border bg-gray-50 dark:bg-dark-bg hover:bg-white dark:hover:bg-dark-surface hover:border-gray-300 transition-all text-left flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-600 shrink-0"></span> <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Nature</span>
                    </button>
                    <button onclick="setPreset('neon')" class="preset-btn py-2 px-3 rounded-lg border border-gray-100 dark:border-dark-border bg-gray-50 dark:bg-dark-bg hover:bg-white dark:hover:bg-dark-surface hover:border-gray-300 transition-all text-left flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-lime-400 shrink-0"></span> <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Neon</span>
                    </button>
                    <button onclick="setPreset('retro')" class="preset-btn py-2 px-3 rounded-lg border border-gray-100 dark:border-dark-border bg-gray-50 dark:bg-dark-bg hover:bg-white dark:hover:bg-dark-surface hover:border-gray-300 transition-all text-left flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-yellow-700 shrink-0"></span> <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Retro</span>
                    </button>
                    <button onclick="setPreset('mono')" class="preset-btn py-2 px-3 rounded-lg border border-gray-100 dark:border-dark-border bg-gray-50 dark:bg-dark-bg hover:bg-white dark:hover:bg-dark-surface hover:border-gray-300 transition-all text-left flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-gray-400 shrink-0"></span> <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Mono</span>
                    </button>
                </div>
            </div>

            <!-- Variability Slider -->
            <div class="space-y-2 pt-2" id="slider-container">
                <div class="flex justify-between items-center">
                    <label class="text-[10px] font-bold text-gray-400 dark:text-dark-muted uppercase tracking-wider">Color Distance</label>
                    <span id="variability-label" class="text-[10px] font-bold bg-gray-100 dark:bg-dark-bg px-2 py-0.5 rounded text-gray-500 dark:text-gray-400">Medium</span>
                </div>
                <input type="range" id="variability" min="10" max="180" value="60" class="w-full">
            </div>

            <!-- Grain Toggle -->
            <div class="flex items-center justify-between py-2">
                <label class="text-[10px] font-bold text-gray-400 dark:text-dark-muted uppercase tracking-wider">Grain Texture</label>
                <button onclick="toggleGrain()" id="btn-grain" class="w-10 h-5 rounded-full bg-gray-200 dark:bg-dark-border relative transition-colors">
                    <div class="w-3 h-3 bg-white rounded-full absolute top-1 left-1 transition-transform" id="grain-knob"></div>
                </button>
            </div>

            <!-- History -->
            <div class="mt-auto pt-4 border-t border-gray-100 dark:border-dark-border">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-[10px] font-bold text-gray-400 dark:text-dark-muted uppercase tracking-wider">History</label>
                    <button onclick="clearHistory()" class="text-[10px] text-gray-400 hover:text-red-500 transition-colors">Clear</button>
                </div>
                <div id="history-container" class="grid grid-cols-6 gap-2"></div>
            </div>
        </aside>

        <!-- Main Display Area -->
        <div id="main-display" class="flex-1 relative w-full h-full bg-white dark:bg-dark-bg overflow-y-auto overflow-x-hidden transition-colors duration-300">
            
            <!-- 1. Palette View (Default) -->
            <div id="view-palette-content" class="w-full h-full flex flex-col md:flex-row"></div>

            <!-- 2. Gradient View -->
            <div id="view-gradient-content" class="hidden w-full h-full flex items-center justify-center p-10">
                <div id="gradient-box" class="w-full max-w-4xl h-full max-h-[600px] rounded-3xl shadow-2xl flex items-center justify-center text-white text-opacity-80">
                    <div class="text-center bg-black/10 backdrop-blur-md p-6 rounded-2xl">
                        <p class="font-mono text-sm mb-2" id="gradient-css">linear-gradient(...)</p>
                        <p class="text-xs opacity-70">CSS Gradient Preview</p>
                    </div>
                </div>
            </div>

            <!-- 3. Mockup View -->
            <div id="view-mockup-content" class="hidden w-full h-full p-4 md:p-10 bg-gray-100 dark:bg-dark-bg overflow-y-auto">
                <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden min-h-[800px] transition-colors duration-500" id="mock-bg">
                    <!-- Fake Nav -->
                    <div class="h-16 flex items-center justify-between px-8 border-b border-black/5" id="mock-nav">
                        <div class="font-bold text-xl tracking-tight" id="mock-logo">Brand.</div>
                        <div class="flex gap-6 text-sm font-medium opacity-60" id="mock-links">
                            <span>Product</span>
                            <span>Stories</span>
                            <span>About</span>
                        </div>
                        <button class="px-5 py-2 rounded-full text-xs font-bold transition-all" id="mock-cta-sm">Get Started</button>
                    </div>
                    <!-- Hero -->
                    <div class="p-12 md:p-24 flex flex-col items-center text-center gap-6">
                        <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-black/5" id="mock-tag">New Release</span>
                        <h1 class="text-5xl md:text-7xl font-black tracking-tighter leading-tight" id="mock-headline">
                            Design the<br>Unexpected.
                        </h1>
                        <p class="max-w-lg text-lg opacity-70 leading-relaxed" id="mock-desc">
                            Experience colors like never before. Create beautiful palettes with a single click.
                        </p>
                        <div class="flex gap-4 mt-4">
                            <button class="px-8 py-4 rounded-xl font-bold shadow-lg transform hover:-translate-y-1 transition-all" id="mock-cta-lg">Start Free Trial</button>
                            <button class="px-8 py-4 rounded-xl font-bold bg-transparent border border-black/10 hover:bg-black/5 transition-all" id="mock-cta-sec">Learn More</button>
                        </div>
                    </div>
                    <!-- Cards -->
                    <div class="grid md:grid-cols-3 gap-6 px-12 pb-24">
                        <div class="h-48 rounded-2xl bg-black/5 p-6 flex flex-col justify-end" id="mock-card-1"><span class="font-bold opacity-50">Feature 01</span></div>
                        <div class="h-48 rounded-2xl bg-black/5 p-6 flex flex-col justify-end" id="mock-card-2"><span class="font-bold opacity-50">Feature 02</span></div>
                        <div class="h-48 rounded-2xl bg-black/5 p-6 flex flex-col justify-end" id="mock-card-3"><span class="font-bold opacity-50">Feature 03</span></div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Hidden Export Template (Offscreen) -->
    <div id="export-container" class="fixed top-0 left-0 -z-50 opacity-0 pointer-events-none w-[1080px] h-[1080px] bg-white flex flex-col">
        <div class="flex-1 flex" id="export-palette-area">
            <!-- Colors injected here -->
        </div>
        <div class="h-32 bg-white flex items-center justify-between px-12 border-t border-gray-100">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">ChromaZen</h2>
                <p class="text-gray-500 mt-1">Palette Export</p>
            </div>
            <div class="flex gap-4 font-mono text-gray-600 font-medium" id="export-codes">
                <!-- Hex codes injected here -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 px-4 py-3 rounded-full flex items-center gap-3 opacity-0 pointer-events-none transition-all duration-300 z-50 translate-y-4 bg-black/90 dark:bg-white/90 text-white dark:text-black shadow-lg">
        <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
        <span class="text-sm font-medium" id="toast-message">Copied!</span>
    </div>

    <!-- CSS Export Modal -->
    <div id="code-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white dark:bg-dark-surface rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden transform scale-95 transition-transform duration-200" id="modal-content">
            <div class="flex justify-between items-center p-4 border-b border-gray-100 dark:border-dark-border">
                <h3 class="font-bold text-gray-800 dark:text-white">Export CSS</h3>
                <button onclick="closeCSSModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-4 bg-gray-50 dark:bg-dark-bg">
                <pre class="mono-font text-xs text-gray-600 dark:text-gray-300 bg-white dark:bg-dark-surface p-4 rounded-lg border border-gray-200 dark:border-dark-border overflow-x-auto select-all" id="css-output"></pre>
            </div>
            <div class="p-4 bg-white dark:bg-dark-surface flex justify-end gap-2">
                <button onclick="closeCSSModal()" class="px-4 py-2 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-dark-bg rounded-lg">Close</button>
                <button onclick="copyCSS()" class="px-4 py-2 text-sm font-medium bg-black dark:bg-white text-white dark:text-black rounded-lg hover:bg-gray-800 dark:hover:bg-gray-200 flex items-center gap-2">
                    <i data-lucide="copy" class="w-4 h-4"></i> Copy Code
                </button>
            </div>
        </div>
    </div>

    <!-- Fine Tuning Modal -->
    <div id="tune-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white dark:bg-dark-surface rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform scale-95 transition-transform duration-200" id="tune-content">
            <div class="p-6">
                <h3 class="font-bold text-gray-800 dark:text-white text-lg mb-4">Edit Color</h3>
                
                <!-- Preview -->
                <div id="tune-preview" class="w-full h-24 rounded-xl shadow-inner mb-6 flex items-center justify-center">
                    <span id="tune-hex-display" class="font-mono text-white/90 font-bold text-xl mix-blend-overlay">#FFFFFF</span>
                </div>

                <!-- Hex Input -->
                <div class="mb-5">
                    <label class="block text-xs font-bold text-gray-400 mb-1">HEX CODE</label>
                    <div class="flex gap-2">
                        <span class="flex items-center justify-center w-8 h-10 bg-gray-100 dark:bg-dark-bg rounded-l-lg text-gray-500">#</span>
                        <input type="text" id="tune-hex-input" class="flex-1 bg-gray-50 dark:bg-dark-bg border-none rounded-r-lg px-3 uppercase font-mono text-gray-800 dark:text-white focus:ring-2 focus:ring-indigo-500 outline-none" maxlength="6">
                    </div>
                </div>

                <!-- HSL Sliders -->
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-xs font-bold text-gray-400">SATURATION</label>
                            <span id="tune-s-val" class="text-xs font-mono text-gray-600 dark:text-gray-300">50%</span>
                        </div>
                        <input type="range" id="tune-s" min="0" max="100" class="w-full">
                        <div class="h-1 w-full bg-gradient-to-r from-gray-300 to-blue-500 rounded-full mt-1 opacity-30"></div>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-xs font-bold text-gray-400">LIGHTNESS</label>
                            <span id="tune-l-val" class="text-xs font-mono text-gray-600 dark:text-gray-300">50%</span>
                        </div>
                        <input type="range" id="tune-l" min="0" max="100" class="w-full">
                        <div class="h-1 w-full bg-gradient-to-r from-black via-gray-400 to-white rounded-full mt-1 opacity-30"></div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 bg-gray-50 dark:bg-dark-bg flex justify-end gap-2">
                <button onclick="closeTuneModal()" class="px-4 py-2 text-sm font-medium text-gray-500 hover:bg-gray-100 dark:hover:bg-dark-surface rounded-lg">Cancel</button>
                <button onclick="applyTune()" class="px-4 py-2 text-sm font-medium bg-black dark:bg-white text-white dark:text-black rounded-lg hover:bg-gray-800 dark:hover:bg-gray-200">
                    Apply Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Contrast Matrix Modal -->
    <div id="contrast-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 modal-backdrop">
        <div class="bg-white dark:bg-dark-surface rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden transform scale-95 transition-transform duration-200" id="contrast-content">
            <div class="flex justify-between items-center p-4 border-b border-gray-100 dark:border-dark-border">
                <h3 class="font-bold text-gray-800 dark:text-white">Contrast Matrix</h3>
                <button onclick="closeContrastModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 bg-white dark:bg-dark-surface">
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                    Check legibility between colors. <strong class="text-green-500">AA</strong> (4.5:1) is good for normal text, <strong class="text-green-600">AAA</strong> (7:1) is excellent.
                </p>
                <div id="contrast-grid" class="grid gap-2">
                    <!-- Matrix Injected Here -->
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- State ---
        let state = {
            mode: 3, 
            colors: [],
            locked: [false, false, false, false, false],
            variability: 60,
            preset: 'none',
            harmony: 'random',
            history: [], 
            actionHistory: [],
            redoStack: [],
            viewMode: 'palette',
            editingIndex: -1, // Currently editing color index
            grain: false
        };

        // --- Constants ---
        const PRESETS = {
            pastel: { sMin: 50, sMax: 90, lMin: 75, lMax: 95 },
            vivid: { sMin: 80, sMax: 100, lMin: 45, lMax: 65 },
            dark: { sMin: 20, sMax: 60, lMin: 10, lMax: 30 },
            warm: { sMin: 50, sMax: 90, lMin: 40, lMax: 80, hRange: [0, 60] },
            nature: { sMin: 20, sMax: 60, lMin: 30, lMax: 70, hRange: [70, 160] },
            neon: { sMin: 90, sMax: 100, lMin: 50, lMax: 60 },
            retro: { sMin: 30, sMax: 60, lMin: 50, lMax: 80, hRange: [20, 50] },
            mono: { sMin: 0, sMax: 0, lMin: 10, lMax: 90 },
            corporate: { sMin: 10, sMax: 40, lMin: 20, lMax: 50, hRange: [200, 240] },
            luxury: { sMin: 20, sMax: 60, lMin: 10, lMax: 40, hRange: [30, 60] },
            pop: { sMin: 80, sMax: 100, lMin: 50, lMax: 60 },
            wedding: { sMin: 5, sMax: 30, lMin: 85, lMax: 98 }
        };

        // --- Utils ---
        const hslToHex = (h, s, l) => {
            h = (h % 360 + 360) % 360;
            l /= 100;
            const a = s * Math.min(l, 1 - l) / 100;
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();
        };

        const hexToRgb = (hex) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        };

        const hexToHsl = (hex) => {
            let {r, g, b} = hexToRgb(hex);
            r /= 255, g /= 255, b /= 255;
            let max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max == min) {
                h = s = 0;
            } else {
                let d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h *= 60;
            }
            return { h: Math.round(h), s: Math.round(s*100), l: Math.round(l*100), hex };
        };

        const getLuminance = (r, g, b) => {
            var a = [r, g, b].map(function (v) {
                v /= 255;
                return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
            });
            return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
        }

        const getContrastRatio = (hex1, hex2) => {
            const rgb1 = hexToRgb(hex1);
            const rgb2 = hexToRgb(hex2);
            if(!rgb1 || !rgb2) return 1;
            const lum1 = getLuminance(rgb1.r, rgb1.g, rgb1.b);
            const lum2 = getLuminance(rgb2.r, rgb2.g, rgb2.b);
            const brightest = Math.max(lum1, lum2);
            const darkest = Math.min(lum1, lum2);
            return (brightest + 0.05) / (darkest + 0.05);
        };

        const getTextColor = (bgColor) => {
            return getContrastRatio(bgColor, '#FFFFFF') > getContrastRatio(bgColor, '#000000') ? '#FFFFFF' : '#101010';
        }

        const showToast = (text) => {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').innerText = text;
            toast.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-4');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4');
            }, 2000);
        };

        const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => showToast(`${text} copied!`));
        };

        // --- Core Generator ---

        const getPresetParams = () => PRESETS[state.preset] || { sMin: 30, sMax: 90, lMin: 20, lMax: 80 };

        const generateColorWithParams = (hue = null) => {
            const p = getPresetParams();
            let h = hue ?? (p.hRange ? Math.floor(Math.random() * (p.hRange[1] - p.hRange[0]) + p.hRange[0]) : Math.floor(Math.random() * 360));
            
            if (state.preset === 'luxury') {
                if (Math.random() > 0.6) { 
                    h = Math.floor(Math.random() * 20) + 35; 
                    p.sMin = 60; p.sMax = 80; p.lMin = 50; p.lMax = 70;
                } else {
                    p.lMax = 15; p.sMax = 20;
                }
            }

            const s = Math.floor(Math.random() * (p.sMax - p.sMin) + p.sMin);
            const l = Math.floor(Math.random() * (p.lMax - p.lMin) + p.lMin);
            return { h, s, l, hex: hslToHex(h, s, l) };
        };

        const generatePalette = (addToUndo = true) => {
            // Button Animation
            const btn = document.getElementById('btn-generate');
            btn.classList.remove('btn-pop');
            void btn.offsetWidth; // trigger reflow
            btn.classList.add('btn-pop');
            createParticles();

            if (addToUndo) saveStateForUndo();

            const count = state.mode;
            let newColors = [...state.colors];
            while(newColors.length < 5) newColors.push(null);

            let baseColor;
            if (state.locked[0] && newColors[0]) {
                baseColor = newColors[0].h ? newColors[0] : hexToHsl(newColors[0].hex);
            } else {
                baseColor = generateColorWithParams();
            }
            newColors[0] = baseColor;

            const harmony = document.getElementById('harmony-select').value;
            const variability = parseInt(document.getElementById('variability').value);
            
            for (let i = 1; i < count; i++) {
                if (state.locked[i] && newColors[i]) continue;

                let nextHue = baseColor.h, nextS = baseColor.s, nextL = baseColor.l;

                if (harmony === 'analogous') nextHue = baseColor.h + (30 * i);
                else if (harmony === 'complementary') nextHue = baseColor.h + (180 * (i % 2));
                else if (harmony === 'triadic') nextHue = baseColor.h + (120 * i);
                else if (harmony === 'monochromatic') {
                    nextHue = baseColor.h;
                    nextL = (baseColor.l + (20 * i)) % 100;
                    if(nextL < 10) nextL += 20; 
                } else {
                    nextHue = baseColor.h + (variability * i);
                    const p = getPresetParams();
                    nextS = Math.floor(Math.random() * (p.sMax - p.sMin) + p.sMin);
                    nextL = Math.floor(Math.random() * (p.lMax - p.lMin) + p.lMin);
                }

                if (harmony !== 'random' && harmony !== 'monochromatic') {
                    const p = getPresetParams();
                    nextS = Math.floor(Math.random() * (p.sMax - p.sMin) + p.sMin);
                    nextL = Math.floor(Math.random() * (p.lMax - p.lMin) + p.lMin);
                }

                newColors[i] = { h: nextHue, s: nextS, l: nextL, hex: hslToHex(nextHue, nextS, nextL) };
            }

            state.colors = newColors.slice(0, count);
            addToHistoryBar();
            render();
            updateSliderVisibility();
        };

        const createParticles = () => {
            const container = document.getElementById('particle-container');
            const colors = ['#EF4444', '#3B82F6', '#10B981', '#F59E0B', '#8B5CF6'];
            
            for(let i=0; i<12; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                const color = colors[Math.floor(Math.random() * colors.length)];
                p.style.backgroundColor = color;
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 60 + 40;
                const tx = Math.cos(angle) * velocity + 'px';
                const ty = Math.sin(angle) * velocity + 'px';
                
                p.style.setProperty('--tx', tx);
                p.style.setProperty('--ty', ty);
                p.style.left = '50%';
                p.style.top = '50%';
                
                container.appendChild(p);
                setTimeout(() => p.remove(), 800);
            }
        };

        // --- History Logic ---
        
        const saveStateForUndo = () => {
            state.actionHistory.push(JSON.parse(JSON.stringify({ 
                colors: state.colors, 
                mode: state.mode,
                locked: state.locked
            })));
            if (state.actionHistory.length > 20) state.actionHistory.shift();
            state.redoStack = []; 
        };

        const undo = () => {
            if (state.actionHistory.length === 0) return;
            state.redoStack.push(JSON.parse(JSON.stringify({ 
                colors: state.colors, 
                mode: state.mode,
                locked: state.locked
            })));
            
            const prev = state.actionHistory.pop();
            state.colors = prev.colors;
            state.mode = prev.mode;
            state.locked = prev.locked;
            
            setModeUI(state.mode);
            render();
        };

        const redo = () => {
            if (state.redoStack.length === 0) return;
            state.actionHistory.push(JSON.parse(JSON.stringify({ 
                colors: state.colors, 
                mode: state.mode,
                locked: state.locked
            })));

            const next = state.redoStack.pop();
            state.colors = next.colors;
            state.mode = next.mode;
            state.locked = next.locked;
            
            setModeUI(state.mode);
            render();
        };

        const addToHistoryBar = () => {
            const paletteSnapshot = state.colors.map(c => c.hex);
            if (state.history.length > 0 && JSON.stringify(state.history[0]) === JSON.stringify(paletteSnapshot)) return;
            state.history.unshift(paletteSnapshot);
            if(state.history.length > 18) state.history.pop();
            renderHistory();
        }

        // --- Rendering ---

        const renderHistory = () => {
            const container = document.getElementById('history-container');
            container.innerHTML = '';
            state.history.forEach(palette => {
                const div = document.createElement('div');
                div.className = 'w-full aspect-square rounded-lg overflow-hidden cursor-pointer hover:ring-2 ring-indigo-500 transition-all flex flex-col shadow-sm border dark:border-gray-700';
                div.onclick = () => loadFromHistory(palette);
                palette.forEach(hex => {
                    const stripe = document.createElement('div');
                    stripe.style.backgroundColor = hex;
                    stripe.className = 'flex-1 w-full';
                    div.appendChild(stripe);
                });
                container.appendChild(div);
            });
        };

        const render = () => {
            if (state.viewMode === 'palette') renderPaletteView();
            else if (state.viewMode === 'gradient') renderGradientView();
            else if (state.viewMode === 'mockup') renderMockupView();
            lucide.createIcons();
        };

        const renderPaletteView = () => {
            const container = document.getElementById('view-palette-content');
            container.innerHTML = '';

            state.colors.forEach((color, index) => {
                const textColor = getTextColor(color.hex);
                const isLocked = state.locked[index];
                
                const panel = document.createElement('div');
                panel.className = 'color-panel flex-1 relative flex flex-col justify-center items-center group cursor-pointer p-2 md:p-4 h-full';
                panel.style.backgroundColor = color.hex;
                panel.style.color = textColor;
                panel.draggable = true;

                panel.ondragstart = (e) => {
                    e.dataTransfer.setData('text/plain', index);
                    e.dataTransfer.effectAllowed = 'move';
                    panel.classList.add('panel-dragging');
                };
                panel.ondragend = () => panel.classList.remove('panel-dragging');
                panel.ondragover = (e) => e.preventDefault();
                panel.ondrop = (e) => {
                    e.preventDefault();
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIndex = index;
                    if (fromIndex !== toIndex) {
                        saveStateForUndo();
                        const temp = state.colors[fromIndex];
                        state.colors[fromIndex] = state.colors[toIndex];
                        state.colors[toIndex] = temp;
                        const tempLock = state.locked[fromIndex];
                        state.locked[fromIndex] = state.locked[toIndex];
                        state.locked[toIndex] = tempLock;
                        render();
                    }
                };

                panel.innerHTML = `
                    <div class="absolute top-4 right-4 md:top-6 md:right-6 flex flex-col gap-2">
                         <button onclick="event.stopPropagation(); toggleLock(${index})" 
                            class="p-2 rounded-full transition-all duration-200 ${isLocked ? 'bg-black/20 text-white' : 'opacity-0 group-hover:opacity-100 hover:bg-black/10'}">
                            <i data-lucide="${isLocked ? 'lock' : 'unlock'}" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div class="absolute top-4 left-4 md:top-6 md:left-6 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="event.stopPropagation(); openTuneModal(${index})" 
                            class="p-2 rounded-full hover:bg-black/10 transition-colors" title="Edit Color">
                            <i data-lucide="sliders" class="w-5 h-5"></i>
                        </button>
                    </div>

                    ${isLocked ? `<div class="absolute top-4 right-4 md:hidden text-white/50"><i data-lucide="lock" class="w-4 h-4"></i></div>` : ''}

                    <div class="text-center transform transition-transform group-hover:scale-105 duration-300">
                        <h2 class="text-2xl md:text-4xl font-black tracking-tight mb-2 uppercase font-mono select-all">${color.hex}</h2>
                        <p class="text-[10px] opacity-60 font-medium tracking-[0.2em] uppercase">
                            ${index + 1}
                        </p>
                    </div>

                    <div class="absolute bottom-12 opacity-0 group-hover:opacity-100 transition-opacity duration-300 md:flex hidden" 
                         onclick="event.stopPropagation(); copyToClipboard('${color.hex}')">
                        <button class="px-4 py-2 rounded-full border border-current bg-white/10 backdrop-blur-sm text-sm font-medium hover:bg-white/20 flex items-center gap-2">
                            <i data-lucide="copy" class="w-3 h-3"></i> Copy
                        </button>
                    </div>
                `;
                container.appendChild(panel);
            });
        };

        const renderGradientView = () => {
            const hexes = state.colors.map(c => c.hex).join(', ');
            const gradientCss = `linear-gradient(to right, ${hexes})`;
            const box = document.getElementById('gradient-box');
            box.style.background = gradientCss;
            document.getElementById('gradient-css').innerText = gradientCss;
        };

        const renderMockupView = () => {
            const c = state.colors;
            const bg = c[0].hex;
            const text = getTextColor(bg) === '#FFFFFF' ? '#FFFFFF' : '#111111'; 
            const mainAcc = c[state.mode > 2 ? 2 : 1].hex;
            const cardBg = c[state.mode > 3 ? 3 : 0].hex; 
            
            const mockContainer = document.getElementById('mock-bg');
            mockContainer.style.backgroundColor = bg;
            mockContainer.style.color = text;

            document.getElementById('mock-nav').style.borderColor = text + '10';
            document.getElementById('mock-logo').style.color = text;
            
            const ctaLg = document.getElementById('mock-cta-lg');
            ctaLg.style.backgroundColor = mainAcc;
            ctaLg.style.color = getTextColor(mainAcc);

            const ctaSm = document.getElementById('mock-cta-sm');
            ctaSm.style.backgroundColor = text;
            ctaSm.style.color = bg;

            ['mock-card-1', 'mock-card-2', 'mock-card-3'].forEach(id => {
                const el = document.getElementById(id);
                el.style.backgroundColor = text + '10'; 
                if(state.mode >= 4) el.style.backgroundColor = c[3].hex;
                el.style.color = state.mode >= 4 ? getTextColor(c[3].hex) : text;
            });
            
            document.getElementById('mock-headline').style.color = text;
        };

        // --- Fine Tuning ---

        const openTuneModal = (index) => {
            state.editingIndex = index;
            const color = state.colors[index];
            
            // Populate inputs
            document.getElementById('tune-hex-input').value = color.hex.replace('#','');
            document.getElementById('tune-hex-display').innerText = color.hex;
            document.getElementById('tune-preview').style.backgroundColor = color.hex;
            
            const sInput = document.getElementById('tune-s');
            const lInput = document.getElementById('tune-l');
            
            sInput.value = color.s;
            lInput.value = color.l;
            
            updateTuneLabels(color.s, color.l);

            // Add live listeners
            sInput.oninput = () => updateTunePreview();
            lInput.oninput = () => updateTunePreview();
            document.getElementById('tune-hex-input').oninput = (e) => updateTuneFromHex(e.target.value);

            document.getElementById('tune-modal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('tune-content').classList.remove('scale-95');
                document.getElementById('tune-content').classList.add('scale-100');
            }, 10);
        };

        const updateTuneLabels = (s, l) => {
            document.getElementById('tune-s-val').innerText = s + '%';
            document.getElementById('tune-l-val').innerText = l + '%';
        }

        const updateTunePreview = () => {
            const h = state.colors[state.editingIndex].h;
            const s = parseInt(document.getElementById('tune-s').value);
            const l = parseInt(document.getElementById('tune-l').value);
            const hex = hslToHex(h, s, l);
            
            document.getElementById('tune-preview').style.backgroundColor = hex;
            document.getElementById('tune-hex-display').innerText = hex;
            document.getElementById('tune-hex-input').value = hex.replace('#','');
            updateTuneLabels(s, l);
        };

        const updateTuneFromHex = (val) => {
            if(val.length === 6) {
                const hex = '#' + val;
                const rgb = hexToRgb(hex);
                if(rgb) {
                    const hsl = hexToHsl(hex);
                    // Update state-like logic only for preview
                    document.getElementById('tune-preview').style.backgroundColor = hex;
                    document.getElementById('tune-hex-display').innerText = hex;
                    document.getElementById('tune-s').value = hsl.s;
                    document.getElementById('tune-l').value = hsl.l;
                    updateTuneLabels(hsl.s, hsl.l);
                }
            }
        }

        const applyTune = () => {
            const hex = document.getElementById('tune-hex-display').innerText;
            const h = state.colors[state.editingIndex].h; // Keep hue roughly? No, re-calc from hex for consistency
            const finalHsl = hexToHsl(hex);
            
            saveStateForUndo();
            state.colors[state.editingIndex] = finalHsl;
            render();
            closeTuneModal();
        };

        const closeTuneModal = () => {
            const content = document.getElementById('tune-content');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                document.getElementById('tune-modal').classList.add('hidden');
            }, 200);
        };

        // --- Contrast Matrix ---
        
        const showContrastModal = () => {
            const modal = document.getElementById('contrast-modal');
            const grid = document.getElementById('contrast-grid');
            grid.innerHTML = '';
            
            // Header Row
            const headerRow = document.createElement('div');
            headerRow.className = `grid gap-2 items-center`;
            headerRow.style.gridTemplateColumns = `40px repeat(${state.mode}, 1fr)`;
            headerRow.innerHTML = `<div></div>` + state.colors.map((c, i) => 
                `<div class="h-6 rounded bg-[${c.hex}]" style="background:${c.hex}"></div>`
            ).join('');
            grid.appendChild(headerRow);

            // Matrix
            state.colors.forEach((rowC, rowI) => {
                const row = document.createElement('div');
                row.className = `grid gap-2 items-center`;
                row.style.gridTemplateColumns = `40px repeat(${state.mode}, 1fr)`;
                
                let cells = `<div class="h-6 w-6 rounded-full" style="background:${rowC.hex}"></div>`;
                
                state.colors.forEach((colC, colI) => {
                    if (rowI === colI) {
                         cells += `<div class="bg-gray-100 dark:bg-gray-800 rounded p-2 text-center text-xs text-gray-400">-</div>`;
                    } else {
                        const ratio = getContrastRatio(rowC.hex, colC.hex).toFixed(2);
                        let badge = '';
                        if(ratio >= 7) badge = '<span class="text-green-600 font-bold">AAA</span>';
                        else if(ratio >= 4.5) badge = '<span class="text-green-500 font-bold">AA</span>';
                        else badge = '<span class="text-red-400">Fail</span>';
                        
                        cells += `<div class="bg-gray-50 dark:bg-dark-bg rounded p-2 text-center text-xs border dark:border-dark-border">
                            <div class="font-mono mb-1">${ratio}</div>
                            ${badge}
                        </div>`;
                    }
                });
                row.innerHTML = cells;
                grid.appendChild(row);
            });

            modal.classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('contrast-content').classList.remove('scale-95');
                document.getElementById('contrast-content').classList.add('scale-100');
            }, 10);
        };

        const closeContrastModal = () => {
             document.getElementById('contrast-modal').classList.add('hidden');
        };

        // --- Interaction ---
        
        const setViewMode = (mode) => {
            state.viewMode = mode;
            document.querySelectorAll('[id^="view-"]').forEach(el => {
                el.classList.remove('bg-white', 'dark:bg-dark-surface', 'text-gray-900', 'dark:text-white', 'shadow-sm');
                el.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            const activeBtn = document.getElementById(`view-${mode}`);
            activeBtn.classList.add('bg-white', 'dark:bg-dark-surface', 'text-gray-900', 'dark:text-white', 'shadow-sm');
            activeBtn.classList.remove('text-gray-500', 'dark:text-gray-400');

            document.getElementById('view-palette-content').classList.add('hidden');
            document.getElementById('view-gradient-content').classList.add('hidden');
            document.getElementById('view-mockup-content').classList.add('hidden');
            document.getElementById(`view-${mode}-content`).classList.remove('hidden');
            render();
        };

        const setMode = (mode) => {
            saveStateForUndo();
            state.mode = mode;
            setModeUI(mode);
            generatePalette(false);
        };

        const setModeUI = (mode) => {
            for(let i=2; i<=5; i++) {
                const btn = document.getElementById(`mode${i}`);
                btn.className = "flex-1 py-1.5 text-xs font-semibold rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-900";
            }
            const active = document.getElementById(`mode${mode}`);
            active.className = "flex-1 py-1.5 text-xs font-semibold rounded-md shadow-sm bg-white dark:bg-dark-surface text-gray-900 dark:text-white";
        };

        const setPreset = (name) => {
            state.preset = name;
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-indigo-500', 'bg-white', 'dark:bg-dark-surface');
                if(btn.innerText.toLowerCase().includes(name)) {
                    btn.classList.add('ring-2', 'ring-indigo-500', 'bg-white', 'dark:bg-dark-surface');
                }
            });
            generatePalette();
        };

        const toggleLock = (index) => {
            state.locked[index] = !state.locked[index];
            render(); 
        };

        const loadFromHistory = (paletteHexArray) => {
            saveStateForUndo();
            state.colors = paletteHexArray.map(hex => hexToHsl(hex));
            state.mode = state.colors.length;
            setModeUI(state.mode);
            render();
        };

        const clearHistory = () => {
            state.history = [];
            renderHistory();
        }
        
        const toggleGrain = () => {
            state.grain = !state.grain;
            const layer = document.getElementById('noise-layer');
            const knob = document.getElementById('grain-knob');
            const btn = document.getElementById('btn-grain');
            
            if(state.grain) {
                layer.style.display = 'block';
                knob.style.transform = 'translateX(20px)';
                btn.classList.replace('bg-gray-200', 'bg-indigo-500');
                btn.classList.replace('dark:bg-dark-border', 'bg-indigo-500');
            } else {
                layer.style.display = 'none';
                knob.style.transform = 'translateX(0)';
                btn.classList.replace('bg-indigo-500', 'bg-gray-200');
                btn.classList.add('dark:bg-dark-border'); // Re-add default dark class logic if removed
            }
        };

        const toggleDarkMode = () => {
            document.body.classList.toggle('dark');
        }

        const updateSliderVisibility = () => {
            const harmony = document.getElementById('harmony-select').value;
            const slider = document.getElementById('slider-container');
            if (harmony === 'random') {
                slider.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                slider.classList.add('opacity-50', 'pointer-events-none');
            }
        }

        // --- Exports ---
        
        const showCSSModal = () => {
            const modal = document.getElementById('code-modal');
            const output = document.getElementById('css-output');
            
            let css = `:root {\n`;
            state.colors.forEach((c, i) => {
                const name = i===0?'primary':i===1?'secondary':i===2?'accent':`color-${i+1}`;
                css += `  --color-${name}: ${c.hex};\n`;
            });
            css += `}\n\n.bg-gradient { background: linear-gradient(to right, ${state.colors.map(c=>c.hex).join(', ')}); }`;
            
            output.innerText = css;
            modal.classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('modal-content').classList.remove('scale-95');
                document.getElementById('modal-content').classList.add('scale-100');
            }, 10);
        };

        const closeCSSModal = () => {
            const content = document.getElementById('modal-content');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => {
                document.getElementById('code-modal').classList.add('hidden');
            }, 200);
        };
        
        const copyCSS = () => {
            copyToClipboard(document.getElementById('css-output').innerText);
            closeCSSModal();
        };

        const exportImage = () => {
            // Populate hidden container
            const area = document.getElementById('export-palette-area');
            const codeArea = document.getElementById('export-codes');
            area.innerHTML = '';
            codeArea.innerHTML = '';
            
            state.colors.forEach(c => {
                const div = document.createElement('div');
                div.style.backgroundColor = c.hex;
                div.className = 'flex-1 h-full';
                area.appendChild(div);
                
                const code = document.createElement('span');
                code.innerText = c.hex;
                codeArea.appendChild(code);
            });
            
            const container = document.getElementById('export-container');
            
            html2canvas(container).then(canvas => {
                const link = document.createElement('a');
                link.download = 'chromazen-palette.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        };

        const downloadASE = () => {
            const colors = state.colors;
            const buffer = [];
            
            const push32 = (val) => { buffer.push((val >> 24) & 0xFF, (val >> 16) & 0xFF, (val >> 8) & 0xFF, val & 0xFF); };
            const push16 = (val) => { buffer.push((val >> 8) & 0xFF, val & 0xFF); };
            const pushString = (str) => {
                push16(str.length + 1);
                for(let i=0; i<str.length; i++) push16(str.charCodeAt(i));
                push16(0);
            };
            const pushFloat = (val) => {
                const view = new DataView(new ArrayBuffer(4));
                view.setFloat32(0, val, false);
                for(let i=0; i<4; i++) buffer.push(view.getUint8(i));
            };

            buffer.push(0x41, 0x53, 0x45, 0x46); // ASEF
            push32(0x00010000); // Ver 1.0
            push32(colors.length); 

            colors.forEach((c, i) => {
                const rgb = hexToRgb(c.hex);
                const r = rgb.r / 255;
                const g = rgb.g / 255;
                const b = rgb.b / 255;
                const name = `Color ${i+1}`;
                
                push16(0xC001); // Color Entry
                
                const data = [];
                const dPush16 = (v) => data.push((v>>8)&0xFF, v&0xFF);
                const dPushString = (s) => {
                    dPush16(s.length+1); 
                    for(let k=0; k<s.length; k++) dPush16(s.charCodeAt(k));
                    dPush16(0);
                };
                const dPushFloat = (v) => {
                    const dv = new DataView(new ArrayBuffer(4));
                    dv.setFloat32(0, v, false);
                    for(let k=0; k<4; k++) data.push(dv.getUint8(k));
                }

                dPushString(name);
                data.push(0x52, 0x47, 0x42, 0x20); // "RGB "
                dPushFloat(r); dPushFloat(g); dPushFloat(b);
                dPush16(2); // Type Global

                push32(data.length); 
                buffer.push(...data);
            });

            const blob = new Blob([new Uint8Array(buffer)], { type: "application/octet-stream" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "chromazen-palette.ase";
            link.click();
        };

        // --- Events ---
        document.getElementById('variability').addEventListener('input', (e) => {
            const val = e.target.value;
            let label = "Medium";
            if(val < 40) label = "Subtle";
            else if(val > 120) label = "High";
            document.getElementById('variability-label').innerText = label;
        });

        document.body.onkeydown = function(e) {
            const key = e.key.toLowerCase();
            // Undo/Redo
            if ((e.ctrlKey || e.metaKey) && key === 'z') {
                e.preventDefault();
                undo();
            }
            if ((e.ctrlKey || e.metaKey) && key === 'y') {
                e.preventDefault();
                redo();
            }
            // Space to generate
            if (key === ' ' && document.activeElement.tagName !== 'INPUT') {
                e.preventDefault();
                generatePalette();
            }
            // Locks
            if (['1','2','3','4','5'].includes(key)) {
                const idx = parseInt(key) - 1;
                if(idx < state.mode) toggleLock(idx);
            }
        }

        // Init
        setModeUI(3);
        generatePalette();

    </script>
</body>
</html>
