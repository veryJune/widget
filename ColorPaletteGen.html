<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChromaZen - Pro Color Tool v5.7 (Fixed)</title>
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#121212',
                            surface: '#1E1E1E',
                            border: '#333333',
                            text: '#EDEDED',
                            muted: '#A1A1AA'
                        }
                    },
                    animation: {
                        'pop': 'pop 0.3s ease-in-out',
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #F5F5F7;
            color: #1D1D1F;
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark { background-color: #121212; color: #EDEDED; }

        /* UI Elements */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%;
            background: #FFFFFF; cursor: pointer; margin-top: -7px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 1px solid rgba(0,0,0,0.1);
        }
        .dark input[type=range]::-webkit-slider-thumb { background: #333; border-color: #555; }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #E5E5E5; border-radius: 2px;
        }
        .dark input[type=range]::-webkit-slider-runnable-track { background: #333; }

        .color-panel { transition: background-color 0.6s cubic-bezier(0.16, 1, 0.3, 1), width 0.3s ease; }
        .panel-locked { box-shadow: inset 0 0 0 4px rgba(0,0,0,0.1); }
        .dark .panel-locked { box-shadow: inset 0 0 0 4px rgba(255,255,255,0.15); }
        .panel-dragging { opacity: 0.5; transform: scale(0.98); z-index: 50; }

        /* Contrast Badge */
        .contrast-badge {
            position: absolute; right: -12px; top: 50%; transform: translateY(-50%); z-index: 10;
            background: white; color: black; border: 1px solid #eee; padding: 2px 6px; border-radius: 999px;
            font-size: 10px; font-weight: bold; opacity: 0; transition: opacity 0.2s; pointer-events: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .color-panel:hover + .color-panel .contrast-badge,
        .color-panel:hover .contrast-badge { opacity: 1; }
        .dark .contrast-badge { background: #333; color: white; border-color: #444; }

        #toast { backdrop-filter: blur(12px); background: rgba(0,0,0,0.85); color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .dark #toast { background: rgba(255,255,255,0.9); color: black; }
        .modal-backdrop { backdrop-filter: blur(5px); background: rgba(0,0,0,0.4); }
        .dark .modal-backdrop { background: rgba(0,0,0,0.8); }

        .scrollbar-thin::-webkit-scrollbar { width: 4px; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #DDD; border-radius: 2px; }
        .dark .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #333; }

        @keyframes pop {
            0% { transform: scale(1); } 40% { transform: scale(0.95); } 70% { transform: scale(1.05); } 100% { transform: scale(1); }
        }
        .btn-pop { animation: pop 0.3s ease-in-out; }
        
        /* Sidebar Transition */
        aside { transition: width 0.3s ease, padding 0.3s ease, opacity 0.3s ease; }
        .sidebar-closed { width: 0; padding: 0; opacity: 0; overflow: hidden; }

        /* Custom Dropdown */
        .custom-select { position: relative; width: 100%; }
        .select-selected {
            background-color: transparent; color: inherit; padding: 10px 12px; border: 1px solid #e5e7eb;
            border-radius: 8px; cursor: pointer; user-select: none; font-size: 0.75rem; font-weight: 500;
            display: flex; justify-content: space-between; align-items: center; background-color: #f9fafb;
        }
        .dark .select-selected { background-color: #121212; border-color: #333; color: #e5e7eb; }
        .select-items {
            position: absolute; background-color: #fff; top: 110%; left: 0; right: 0; z-index: 99;
            border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            overflow: hidden; display: none;
        }
        .dark .select-items { background-color: #1e1e1e; border-color: #333; }
        .select-items div {
            color: #374151; padding: 8px 12px; cursor: pointer; user-select: none; font-size: 0.75rem;
        }
        .dark .select-items div { color: #e5e7eb; }
        .select-items div:hover { background-color: #f3f4f6; }
        .dark .select-items div:hover { background-color: #333; }
        .select-hide { display: none; }
        .select-arrow-active { transform: rotate(180deg); }

        /* Accessibility Filters */
        .filter-protanopia { filter: url(#protanopia); }
        .filter-deuteranopia { filter: url(#deuteranopia); }
        .filter-tritanopia { filter: url(#tritanopia); }
        .filter-achromatopsia { filter: url(#achromatopsia); }
    </style>
</head>
<body class="h-screen w-full flex flex-col overflow-hidden select-none transition-colors duration-300">

    <!-- SVG Filters for Color Blindness -->
    <svg style="display: none">
        <defs>
            <filter id="protanopia"><feColorMatrix type="matrix" values="0.567, 0.433, 0, 0, 0 0.558, 0.442, 0, 0, 0 0, 0.242, 0.758, 0, 0 0, 0, 0, 1, 0"/></filter>
            <filter id="deuteranopia"><feColorMatrix type="matrix" values="0.625, 0.375, 0, 0, 0 0.7, 0.3, 0, 0, 0 0, 0.3, 0.7, 0, 0 0, 0, 0, 1, 0"/></filter>
            <filter id="tritanopia"><feColorMatrix type="matrix" values="0.95, 0.05, 0, 0, 0 0, 0.433, 0.567, 0, 0 0, 0.475, 0.525, 0, 0 0, 0, 0, 1, 0"/></filter>
            <filter id="achromatopsia"><feColorMatrix type="matrix" values="0.299, 0.587, 0.114, 0, 0 0.299, 0.587, 0.114, 0, 0 0.299, 0.587, 0.114, 0, 0 0, 0, 0, 1, 0"/></filter>
        </defs>
    </svg>

    <!-- Header -->
    <header class="h-16 flex items-center justify-between px-4 md:px-6 bg-white dark:bg-dark-surface border-b border-gray-200 dark:border-dark-border z-20 shrink-0 transition-colors">
        <div class="flex items-center gap-3">
            <button onclick="App.ui.toggleSidebar()" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-bg text-gray-500 transition-colors" title="Toggle Sidebar (Zen Mode)">
                <i data-lucide="menu" class="w-5 h-5"></i>
            </button>
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-white shadow-md">
                    <i data-lucide="palette" class="w-4 h-4"></i>
                </div>
                <h1 class="text-lg font-bold tracking-tight text-gray-900 dark:text-white leading-none hidden md:block">ChromaZen <span class="text-[10px] font-medium text-gray-400 dark:text-gray-500 ml-1">v5.7</span></h1>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <!-- View Modes -->
            <div class="hidden md:flex bg-gray-100 dark:bg-dark-bg p-1 rounded-lg border dark:border-dark-border">
                <button onclick="App.ui.setViewMode('palette')" id="view-palette" class="view-btn px-3 py-1.5 text-xs font-semibold rounded-md flex items-center gap-1.5 transition-all bg-white dark:bg-dark-surface shadow-sm"><i data-lucide="columns" class="w-3 h-3"></i> Palette</button>
                <button onclick="App.ui.setViewMode('gradient')" id="view-gradient" class="view-btn px-3 py-1.5 text-xs font-semibold rounded-md flex items-center gap-1.5 transition-all text-gray-500 dark:text-gray-400"><i data-lucide="activity" class="w-3 h-3"></i> Gradient</button>
                <button onclick="App.ui.setViewMode('mockup')" id="view-mockup" class="view-btn px-3 py-1.5 text-xs font-semibold rounded-md flex items-center gap-1.5 transition-all text-gray-500 dark:text-gray-400"><i data-lucide="layout-template" class="w-3 h-3"></i> Mockup</button>
                <button onclick="App.ui.setViewMode('typography')" id="view-typography" class="view-btn px-3 py-1.5 text-xs font-semibold rounded-md flex items-center gap-1.5 transition-all text-gray-500 dark:text-gray-400"><i data-lucide="type" class="w-3 h-3"></i> Typography</button>
            </div>

            <div class="h-6 w-px bg-gray-200 dark:bg-dark-border hidden md:block"></div>

            <button onclick="App.logic.savePalette()" class="p-2 rounded-lg border border-gray-200 dark:border-dark-border text-gray-500 hover:text-red-500 hover:bg-red-50 dark:hover:bg-dark-bg transition-colors" title="Save to Library">
                <i data-lucide="heart" class="w-4 h-4"></i>
            </button>

            <!-- Export -->
            <div class="relative z-50">
                <button onclick="App.ui.toggleExportMenu(event)" class="px-3 py-2 text-xs font-medium rounded-lg bg-black dark:bg-white text-white dark:text-black hover:opacity-90 transition-all flex items-center gap-2">
                    <i data-lucide="download" class="w-3 h-3"></i> Export
                </button>
                <div id="export-menu" class="absolute right-0 mt-2 w-48 bg-white dark:bg-dark-surface rounded-xl shadow-xl border border-gray-100 dark:border-dark-border hidden p-1 z-50">
                    <button onclick="App.exports.image()" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-50 dark:hover:bg-dark-bg dark:text-gray-200 rounded-lg flex items-center gap-2"><i data-lucide="image" class="w-3 h-3 text-pink-500"></i> Image (PNG)</button>
                    <button onclick="App.exports.css()" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-50 dark:hover:bg-dark-bg dark:text-gray-200 rounded-lg flex items-center gap-2"><i data-lucide="code" class="w-3 h-3 text-blue-500"></i> CSS Variables</button>
                    <button onclick="App.exports.tailwind()" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-50 dark:hover:bg-dark-bg dark:text-gray-200 rounded-lg flex items-center gap-2"><i data-lucide="wind" class="w-3 h-3 text-cyan-500"></i> Tailwind Config</button>
                    <button onclick="App.exports.ase()" class="w-full text-left px-3 py-2 text-xs hover:bg-gray-50 dark:hover:bg-dark-bg dark:text-gray-200 rounded-lg flex items-center gap-2"><i data-lucide="file-box" class="w-3 h-3 text-purple-500"></i> Adobe ASE</button>
                </div>
            </div>

            <!-- Color Blindness Toggle -->
            <button onclick="App.ui.toggleColorBlindness()" id="btn-blindness" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors relative" title="Color Blindness Simulator">
                <i data-lucide="eye" class="w-5 h-5"></i>
                <span id="blindness-indicator" class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full hidden"></span>
            </button>

            <!-- Sound Toggle -->
            <button onclick="App.ui.toggleSound()" id="btn-sound" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors" title="Toggle Sound">
                <i data-lucide="volume-x" class="w-5 h-5"></i>
            </button>

            <!-- Shortcuts -->
            <button onclick="App.ui.showShortcuts()" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors" title="Shortcuts">
                <i data-lucide="help-circle" class="w-5 h-5"></i>
            </button>

            <!-- Dark Mode -->
            <button onclick="App.ui.toggleDarkMode()" class="p-2 text-gray-400 hover:text-yellow-500 transition-colors" title="Toggle Dark Mode">
                <i data-lucide="sun" class="w-5 h-5 dark:hidden"></i><i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 flex flex-col md:flex-row relative overflow-hidden bg-gray-50 dark:bg-dark-bg transition-colors" id="app-main">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="w-full md:w-80 bg-white dark:bg-dark-surface border-r border-gray-200 dark:border-dark-border p-5 flex flex-col gap-6 z-10 overflow-y-auto scrollbar-thin shrink-0">
            
            <!-- Generate -->
            <div class="space-y-3">
                <div class="flex bg-gray-100 dark:bg-dark-bg p-1 rounded-lg w-full border dark:border-dark-border">
                    <button data-mode="2" class="mode-btn flex-1 py-1.5 text-xs font-semibold rounded-md text-gray-500" onclick="App.logic.setMode(2)">2</button>
                    <button data-mode="3" class="mode-btn flex-1 py-1.5 text-xs font-semibold rounded-md shadow-sm bg-white dark:bg-dark-surface" onclick="App.logic.setMode(3)">3</button>
                    <button data-mode="4" class="mode-btn flex-1 py-1.5 text-xs font-semibold rounded-md text-gray-500" onclick="App.logic.setMode(4)">4</button>
                    <button data-mode="5" class="mode-btn flex-1 py-1.5 text-xs font-semibold rounded-md text-gray-500" onclick="App.logic.setMode(5)">5</button>
                </div>
                <button id="btn-generate" onclick="App.logic.generate(true, event)" 
                    onmouseenter="App.ui.updateInfo('Tip: Shift + Click for Smart Shuffle (Keep Tone, Change Hue)')" 
                    onmouseleave="App.ui.resetInfo()"
                    class="w-full py-3.5 bg-black dark:bg-white dark:text-black text-white rounded-xl text-base font-bold shadow-lg hover:shadow-xl active:scale-95 transition-all flex items-center justify-center gap-2 group">
                    <i data-lucide="shuffle" class="w-4 h-4 group-hover:rotate-180 transition-transform duration-500"></i> Generate
                </button>
            </div>

            <!-- Controls -->
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 dark:text-dark-muted uppercase tracking-wider mb-2 block">Harmony Rule</label>
                    <!-- Custom Select for Hover Tips -->
                    <div class="custom-select" id="harmony-dropdown" 
                         onmouseenter="App.ui.updateInfo(App.logic.getInfoText(App.state.harmony))" 
                         onmouseleave="App.ui.resetInfo()">
                        <div class="select-selected" onclick="App.ui.toggleDropdown(event)">
                            <span id="selected-harmony">ðŸŽ² Random Shuffle</span>
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                        <div class="select-items select-hide" id="harmony-items">
                            <!-- JS injected -->
                        </div>
                    </div>
                </div>
                <div onmouseenter="App.ui.updateInfo(App.logic.getInfoText('spread'))" onmouseleave="App.ui.resetInfo()">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-[10px] font-bold text-gray-400 dark:text-dark-muted uppercase tracking-wider">Spread</label>
                        <span id="variability-label" class="text-[10px] font-mono bg-gray-100 dark:bg-dark-bg px-1.5 py-0.5 rounded text-gray-500">30</span>
                    </div>
                    <input type="range" id="variability" min="5" max="100" value="30" class="w-full accent-black dark:accent-white" oninput="App.ui.updateSliderLabel(this.value)">
                </div>
            </div>

            <div class="border-t border-gray-100 dark:border-dark-border pt-4">
                <label class="text-[10px] font-bold text-gray-400 dark:text-dark-muted uppercase tracking-wider mb-2 block">Image Match</label>
                <div class="relative group" onmouseenter="App.ui.updateInfo(App.logic.getInfoText('imagematch'))" onmouseleave="App.ui.resetInfo()">
                    <input type="file" id="image-upload" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="App.logic.extractFromImage(this.files[0])">
                    <div class="w-full py-3 border-2 border-dashed border-gray-200 dark:border-dark-border rounded-xl flex items-center justify-center gap-2 text-xs font-medium text-gray-500 group-hover:border-indigo-500 group-hover:text-indigo-500 transition-colors bg-gray-50 dark:bg-dark-bg">
                        <i data-lucide="image-plus" class="w-4 h-4"></i> Upload / Ctrl+V
                    </div>
                </div>
            </div>

            <!-- 3-Tab System -->
            <div class="flex-1 flex flex-col min-h-0">
                <div class="flex border-b border-gray-100 dark:border-dark-border mb-3">
                    <button class="flex-1 pb-2 text-xs font-bold border-b-2 border-black dark:border-white text-black dark:text-white" id="tab-presets" onclick="App.ui.switchSidebarTab('presets')">Presets</button>
                    <button class="flex-1 pb-2 text-xs font-bold border-b-2 border-transparent text-gray-400 hover:text-gray-600" id="tab-library" onclick="App.ui.switchSidebarTab('library')">Library</button>
                    <button class="flex-1 pb-2 text-xs font-bold border-b-2 border-transparent text-gray-400 hover:text-gray-600" id="tab-history" onclick="App.ui.switchSidebarTab('history')">History</button>
                </div>
                
                <div id="sidebar-presets" class="flex-1 overflow-y-auto scrollbar-thin">
                    <div class="grid grid-cols-2 gap-2" id="presets-grid"></div>
                </div>
                <div id="sidebar-library" class="flex-1 overflow-y-auto scrollbar-thin hidden">
                    <div id="library-container" class="space-y-2"></div>
                </div>
                <div id="sidebar-history" class="flex-1 overflow-y-auto scrollbar-thin hidden flex-col">
                    <div class="flex justify-end mb-2">
                        <button onclick="App.logic.clearHistory()" class="text-[10px] text-red-500 hover:text-red-700 font-bold uppercase tracking-wider flex items-center gap-1">
                            <i data-lucide="trash-2" class="w-3 h-3"></i> Clear History
                        </button>
                    </div>
                    <div id="history-container" class="grid grid-cols-4 gap-2"></div>
                </div>
            </div>

            <!-- Info Panel -->
            <div class="mt-2 mb-2 p-3 bg-gray-50 dark:bg-dark-bg border border-gray-100 dark:border-dark-border rounded-lg min-h-[60px] flex items-center shrink-0">
                <p id="info-text" class="text-xs text-gray-500 dark:text-gray-400 leading-snug">Hover over controls or presets for details.</p>
            </div>
        </aside>

        <!-- Main Display -->
        <div id="main-display" class="flex-1 relative w-full h-full bg-white dark:bg-dark-bg overflow-y-auto overflow-x-hidden">
            <div id="view-palette-content" class="w-full h-full flex flex-col md:flex-row"></div>
            
            <div id="view-gradient-content" class="hidden w-full h-full flex flex-col items-center justify-center p-10 gap-6">
                <div id="gradient-box" class="w-full max-w-4xl h-64 md:h-96 rounded-3xl shadow-2xl transition-all duration-300"></div>
                <!-- Gradient Angle Control -->
                <div class="flex items-center gap-4 bg-white dark:bg-dark-surface p-4 rounded-xl shadow-sm border border-gray-100 dark:border-dark-border">
                    <span class="text-xs font-bold uppercase text-gray-400">Angle</span>
                    <input type="range" min="0" max="360" value="90" class="w-32" oninput="App.ui.updateGradientAngle(this.value)">
                    <span class="text-xs font-mono w-8 text-right" id="grad-angle-val">90Â°</span>
                </div>
                <p class="font-mono text-xs md:text-sm bg-black/5 dark:bg-white/10 backdrop-blur-md px-4 py-2 rounded-lg cursor-pointer hover:bg-black/10 dark:hover:bg-white/20 transition-colors text-gray-600 dark:text-gray-300" id="gradient-css" onclick="App.utils.copy(this.innerText)">Code</p>
            </div>

            <!-- Sticky Remix Header for Mockup -->
            <div id="view-mockup-content" class="hidden w-full h-full relative">
                <div class="sticky top-0 z-30 w-full flex justify-end p-4 pointer-events-none">
                    <button id="btn-remix-mockup" onclick="App.logic.remix()" class="pointer-events-auto px-5 py-2.5 rounded-full shadow-lg font-bold flex items-center gap-2 transition-all hover:scale-105 active:scale-95 border-2 bg-white/80 backdrop-blur-sm dark:bg-black/80">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> Remix Colors
                    </button>
                </div>
                
                <div class="max-w-6xl mx-auto space-y-6 pb-20 px-4 md:px-10 -mt-16 pt-20"> 
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6 min-h-[800px] rounded-3xl overflow-hidden shadow-2xl transition-colors" id="mock-container">
                        <!-- Hero -->
                        <div class="md:col-span-12 p-12 md:p-16 flex flex-col md:flex-row items-center justify-between relative overflow-hidden transition-colors" id="mock-hero">
                            <div class="relative z-10 max-w-lg space-y-6">
                                <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-widest backdrop-blur-sm bg-white/20" id="mock-badge">New Arrival</div>
                                <h1 class="text-6xl md:text-8xl font-black tracking-tighter leading-[0.9]" id="mock-title">MAKE<br>WAVES.</h1>
                                <p class="text-lg opacity-80 max-w-sm font-medium" id="mock-subtitle">Experience the next generation of creative tools.</p>
                                <div class="flex gap-4 pt-4">
                                    <button class="px-8 py-4 rounded-full font-bold shadow-lg hover:scale-105 transition-transform" id="mock-btn-primary">Get Started</button>
                                    <button class="px-8 py-4 rounded-full font-bold border-2 hover:bg-white/10 transition-colors" id="mock-btn-secondary">Learn More</button>
                                </div>
                            </div>
                            <div class="absolute right-0 top-0 w-full h-full md:w-1/2 opacity-30 pointer-events-none" id="mock-shapes"></div>
                        </div>
                        <!-- Cards -->
                        <div class="md:col-span-4 p-10 rounded-3xl flex flex-col justify-between transition-colors" id="mock-card-1">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center bg-black/10 mb-6"><i data-lucide="zap" class="w-6 h-6"></i></div>
                            <div><h3 class="text-2xl font-bold mb-2">Fast</h3><p class="opacity-70 text-sm">Lightning quick color generation.</p></div>
                        </div>
                        <div class="md:col-span-4 p-10 rounded-3xl flex flex-col justify-between transition-colors border-2 border-dashed" id="mock-card-2">
                            <div class="w-full h-24 flex items-end gap-2 mb-6 opacity-50">
                                <div class="w-1/4 h-1/2 bg-current rounded-t-lg"></div><div class="w-1/4 h-3/4 bg-current rounded-t-lg"></div><div class="w-1/4 h-full bg-current rounded-t-lg"></div><div class="w-1/4 h-2/3 bg-current rounded-t-lg"></div>
                            </div>
                            <div><h3 class="text-2xl font-bold mb-2">Analytics</h3><p class="opacity-70 text-sm">Data driven decisions.</p></div>
                        </div>
                        <div class="md:col-span-4 p-10 rounded-3xl flex flex-col justify-center items-center text-center transition-colors relative overflow-hidden" id="mock-card-3">
                            <div class="absolute inset-0 opacity-20 bg-gradient-to-tr from-transparent to-black"></div><h3 class="text-3xl font-black relative z-10">PRO<br>MODE</h3>
                        </div>
                        <!-- Footer -->
                        <div class="md:col-span-12 p-10 flex justify-between items-center transition-colors" id="mock-footer">
                            <span class="font-bold text-xl tracking-tight">Brand.</span><div class="flex gap-6 text-sm font-medium opacity-60"><span>Privacy</span><span>Terms</span><span>Contact</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sticky Remix Header for Typography -->
            <div id="view-typography-content" class="hidden w-full h-full relative">
                <div class="sticky top-0 z-30 w-full flex justify-between p-4 pointer-events-none items-center">
                    <div class="pointer-events-auto bg-white dark:bg-dark-surface p-1 rounded-lg border border-gray-200 dark:border-dark-border shadow-sm flex">
                        <button onclick="App.ui.setFont('sans')" class="px-3 py-1.5 text-xs font-bold rounded-md hover:bg-gray-100 dark:hover:bg-dark-bg font-sans" id="font-sans">Sans</button>
                        <button onclick="App.ui.setFont('serif')" class="px-3 py-1.5 text-xs font-bold rounded-md hover:bg-gray-100 dark:hover:bg-dark-bg font-serif" id="font-serif">Serif</button>
                        <button onclick="App.ui.setFont('mono')" class="px-3 py-1.5 text-xs font-bold rounded-md hover:bg-gray-100 dark:hover:bg-dark-bg font-mono" id="font-mono">Mono</button>
                    </div>
                    
                    <button id="btn-remix-typo" onclick="App.logic.remix()" class="pointer-events-auto px-5 py-2.5 rounded-full shadow-lg font-bold flex items-center gap-2 transition-all hover:scale-105 active:scale-95 border-2 bg-white/80 backdrop-blur-sm dark:bg-black/80">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> Remix Colors
                    </button>
                </div>

                <div class="max-w-5xl mx-auto space-y-6 pb-20 px-4 md:px-10 -mt-16 pt-20">
                    <div id="typo-inject-area"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Hidden Export -->
    <div id="export-container" class="fixed top-0 left-[-9999px] w-[1080px] h-[1080px] bg-white flex flex-col pointer-events-none opacity-100 z-[-1]">
        <div class="flex-1 flex" id="export-palette-area"></div>
        <div class="h-32 bg-white flex items-center justify-between px-12 border-t border-gray-100">
            <div><h2 class="text-4xl font-bold text-gray-900 tracking-tight">ChromaZen</h2></div>
            <div class="flex gap-6 font-mono text-xl text-gray-600 font-medium" id="export-codes"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 modal-backdrop opacity-0 transition-opacity duration-200"></div>
    <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 px-5 py-3 rounded-full flex items-center gap-3 opacity-0 pointer-events-none transition-all duration-300 z-50 translate-y-4">
        <span class="text-sm font-medium" id="toast-message">Notification</span>
    </div>

    <script>
        // Fixed NAMED_COLORS with correct object syntax
        const NAMED_COLORS = [
            {r:255,g:255,b:255,n:"White"},{r:0,g:0,b:0,n:"Black"},{r:255,g:0,b:0,n:"Red"},{r:0,g:255,b:0,n:"Lime"},{r:0,g:0,b:255,n:"Blue"},
            {r:255,g:255,b:0,n:"Yellow"},{r:0,g:255,b:255,n:"Cyan"},{r:255,g:0,b:255,n:"Magenta"},{r:192,g:192,b:192,n:"Silver"},{r:128,g:128,b:128,n:"Gray"},
            {r:128,g:0,b:0,n:"Maroon"},{r:128,g:128,b:0,n:"Olive"},{r:0,g:128,b:0,n:"Green"},{r:128,g:0,b:128,n:"Purple"},{r:0,g:128,b:128,n:"Teal"},
            {r:0,g:0,b:128,n:"Navy"},{r:255,g:165,b:0,n:"Orange"},{r:255,g:99,b:71,n:"Tomato"},{r:255,g:69,b:0,n:"Red Orange"},{r:255,g:215,b:0,n:"Gold"},
            {r:218,g:165,b:32,n:"Goldenrod"},{r:75,g:0,b:130,n:"Indigo"},{r:60,g:179,b:113,n:"Sea Green"},{r:32,g:178,b:170,n:"Light Sea Green"},{r:0,g:191,b:255,n:"Deep Sky Blue"},
            {r:70,g:130,b:180,n:"Steel Blue"},{r:135,g:206,b:235,n:"Sky Blue"},{r:25,g:25,b:112,n:"Midnight Blue"},{r:220,g:20,b:60,n:"Crimson"},{r:255,g:20,b:147,n:"Deep Pink"},
            {r:255,g:182,b:193,n:"Light Pink"},{r:255,g:140,b:0,n:"Dark Orange"},{r:255,g:127,b:80,n:"Coral"},{r:233,g:150,b:122,n:"Dark Salmon"},{r:245,g:222,b:179,n:"Wheat"},
            {r:210,g:105,b:30,n:"Chocolate"},{r:139,g:69,b:19,n:"Saddle Brown"},{r:160,g:82,b:45,n:"Sienna"},{r:240,g:248,b:255,n:"Alice Blue"},{r:47,g:79,b:79,n:"Dark Slate Gray"},
            {r:112,g:128,b:144,n:"Slate Gray"},{r:105,g:105,b:105,n:"Dim Gray"},{r:255,g:228,b:181,n:"Moccasin"},{r:255,g:228,b:196,n:"Bisque"},
            {r:250,g:128,b:114,n:"Salmon"},{r:255,g:160,b:122,n:"Light Salmon"},{r:255,g:218,b:185,n:"Peach Puff"},{r:255,g:222,b:173,n:"Navajo White"},{r:255,g:228,b:225,n:"Misty Rose"},
            {r:255,g:240,b:245,n:"Lavender Blush"},{r:255,g:250,b:250,n:"Snow"},{r:248,g:248,b:255,n:"Ghost White"},{r:245,g:245,b:245,n:"White Smoke"},{r:220,g:220,b:220,n:"Gainsboro"},
            {r:211,g:211,b:211,n:"Light Gray"},{r:169,g:169,b:169,n:"Dark Gray"},{r:255,g:255,b:224,n:"Light Yellow"},{r:255,g:255,b:240,n:"Ivory"},{r:255,g:239,b:213,n:"Papaya Whip"},
            {r:255,g:235,b:205,n:"Blanched Almond"},{r:188,g:143,b:143,n:"Rosy Brown"},{r:205,g:92,b:92,n:"Indian Red"},{r:165,g:42,b:42,n:"Brown"},{r:178,g:34,b:34,n:"Firebrick"},
            {r:139,g:0,b:0,n:"Dark Red"},{r:154,g:205,b:50,n:"Yellow Green"},{r:85,g:107,b:47,n:"Dark Olive Green"},{r:107,g:142,b:35,n:"Olive Drab"},{r:124,g:252,b:0,n:"Lawn Green"},
            {r:127,g:255,b:0,n:"Chartreuse"},{r:173,g:255,b:47,n:"Green Yellow"},{r:50,g:205,b:50,n:"Lime Green"},{r:144,g:238,b:144,n:"Light Green"},{r:152,g:251,b:152,n:"Pale Green"},
            {r:0,g:250,b:154,n:"Medium Spring Green"},{r:0,g:255,b:127,n:"Spring Green"},{r:46,g:139,b:87,n:"Sea Green"},{r:34,g:139,b:34,n:"Forest Green"},{r:0,g:128,b:0,n:"Green"},
            {r:0,g:100,b:0,n:"Dark Green"},{r:102,g:205,b:170,n:"Medium Aquamarine"},{r:0,g:255,b:255,n:"Aqua"},{r:224,g:255,b:255,n:"Light Cyan"},{r:175,g:238,b:238,n:"Pale Turquoise"},
            {r:127,g:255,b:212,n:"Aquamarine"},{r:64,g:224,b:208,n:"Turquoise"},{r:72,g:209,b:204,n:"Medium Turquoise"},{r:0,g:206,b:209,n:"Dark Turquoise"},{r:95,g:158,b:160,n:"Cadet Blue"},
            {r:176,g:196,b:222,n:"Light Steel Blue"},{r:173,g:216,b:230,n:"Light Blue"},{r:135,g:206,b:250,n:"Light Sky Blue"},{r:30,g:144,b:255,n:"Dodger Blue"},{r:100,g:149,b:237,n:"Cornflower Blue"},
            {r:65,g:105,b:225,n:"Royal Blue"},{r:0,g:0,b:205,n:"Medium Blue"},{r:0,g:0,b:139,n:"Dark Blue"},{r:0,g:0,b:128,n:"Navy"},{r:138,g:43,b:226,n:"Blue Violet"},{r:72,g:61,b:139,n:"Dark Slate Blue"},
            {r:106,g:90,b:205,n:"Slate Blue"},{r:123,g:104,b:238,n:"Medium Slate Blue"},{r:147,g:112,b:219,n:"Medium Purple"},{r:153,g:50,b:204,n:"Dark Orchid"},{r:148,g:0,b:211,n:"Dark Violet"},
            {r:186,g:85,b:211,n:"Medium Orchid"},{r:216,g:191,b:216,n:"Thistle"},{r:221,g:160,b:221,n:"Plum"},{r:218,g:112,b:214,n:"Orchid"},{r:199,g:21,b:133,n:"Medium Violet Red"},
            {r:219,g:112,b:147,n:"Pale Violet Red"},{r:255,g:105,b:180,n:"Hot Pink"},{r:54,g:69,b:79,n:"Charcoal"},{r:42,g:52,b:57,n:"Gunmetal"},{r:10,g:10,b:10,n:"Jet Black"},
            {r:255,g:250,b:240,n:"Floral White"},{r:253,g:245,b:230,n:"Old Lace"},{r:250,g:240,b:230,n:"Linen"},{r:250,g:235,b:215,n:"Antique White"},{r:255,g:228,b:181,n:"Moccasin"},
            {r:240,g:128,b:128,n:"Light Coral"},{r:233,g:150,b:122,n:"Dark Salmon"},{r:205,g:92,b:92,n:"Indian Red"},{r:220,g:20,b:60,n:"Crimson"},{r:176,g:224,b:230,n:"Powder Blue"},
            {r:135,g:206,b:235,n:"Sky Blue"},{r:135,g:206,b:250,n:"Light Sky Blue"},{r:70,g:130,b:180,n:"Steel Blue"},{r:25,g:25,b:112,n:"Midnight Blue"},{r:128,g:0,b:0,n:"Maroon"},
            {r:139,g:69,b:19,n:"Saddle Brown"},{r:160,g:82,b:45,n:"Sienna"},{r:210,g:105,b:30,n:"Chocolate"},{r:205,g:133,b:63,n:"Peru"},{r:244,g:164,b:96,n:"Sandy Brown"},
            {r:222,g:184,b:135,n:"Burlywood"},{r:210,g:180,b:140,n:"Tan"},{r:188,g:143,b:143,n:"Rosy Brown"},{r:245,g:245,b:220,n:"Beige"},{r:255,g:240,b:245,n:"Lavender Blush"},
            {r:255,g:228,b:225,n:"Misty Rose"},{r:255,g:245,b:238,n:"Seashell"},{r:255,g:250,b:250,n:"Snow"},{r:248,g:248,b:255,n:"Ghost White"},{r:240,g:248,b:255,n:"Alice Blue"},
            {r:240,g:255,b:255,n:"Azure"},{r:245,g:255,b:250,n:"Mint Cream"},{r:255,g:255,b:240,n:"Ivory"},{r:250,g:235,b:215,n:"Antique White"},{r:250,g:240,b:230,n:"Linen"},
            {r:253,g:245,b:230,n:"Old Lace"},{r:255,g:250,b:240,n:"Floral White"},{r:255,g:228,b:196,n:"Bisque"},{r:255,g:218,b:185,n:"Peach Puff"},{r:255,g:222,b:173,n:"Navajo White"},
            {r:255,g:228,b:181,n:"Moccasin"},{r:255,g:248,b:220,n:"Cornsilk"},{r:255,g:250,b:205,n:"Lemon Chiffon"},{r:250,g:250,b:210,n:"Light Goldenrod Yellow"},{r:255,g:255,b:224,n:"Light Yellow"},
            {r:255,g:255,b:0,n:"Yellow"},{r:128,g:128,b:0,n:"Olive"},{r:107,g:142,b:35,n:"Olive Drab"},{r:85,g:107,b:47,n:"Dark Olive Green"},{r:154,g:205,b:50,n:"Yellow Green"},
            {r:127,g:255,b:0,n:"Chartreuse"},{r:124,g:252,b:0,n:"Lawn Green"},{r:0,g:255,b:0,n:"Lime"},{r:50,g:205,b:50,n:"Lime Green"},{r:0,g:255,b:127,n:"Spring Green"},
            {r:0,g:250,b:154,n:"Medium Spring Green"},{r:64,g:224,b:208,n:"Turquoise"},{r:72,g:209,b:204,n:"Medium Turquoise"},{r:32,g:178,b:170,n:"Light Sea Green"},{r:0,g:139,b:139,n:"Dark Cyan"},
            {r:0,g:128,b:128,n:"Teal"},{r:0,g:255,b:255,n:"Aqua"},{r:0,g:255,b:255,n:"Cyan"},{r:224,g:255,b:255,n:"Light Cyan"},{r:175,g:238,b:238,n:"Pale Turquoise"},
            {r:127,g:255,b:212,n:"Aquamarine"},{r:240,g:255,b:255,n:"Azure"},{r:245,g:255,b:250,n:"Mint Cream"},{r:255,g:255,b:255,n:"White"}
        ];

        const App = {
            state: {
                mode: 3, colors: [], locked: [false,false,false,false,false], variability: 30, preset: 'none', harmony: 'random',
                history: [], library: JSON.parse(localStorage.getItem('chromazen_library') || '[]'),
                undoStack: [], redoStack: [], viewMode: 'palette', grain: false, darkMode: false, editingIndex: -1,
                colorOffset: 0, typoFont: 'sans', sidebarOpen: true, activeTab: 'presets', soundEnabled: false, // Default Mute
                gradientAngle: 90, blindnessMode: 0
            },
            utils: {
                hslToHex: (h, s, l) => {
                    h = (h % 360 + 360) % 360; l /= 100; const a = s * Math.min(l, 1 - l) / 100;
                    const f = n => { const k = (n + h / 30) % 12; const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1); return Math.round(255 * color).toString(16).padStart(2, '0'); };
                    return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();
                },
                hexToHsl: (hex) => {
                    let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                    let r = parseInt(result[1], 16)/255, g = parseInt(result[2], 16)/255, b = parseInt(result[3], 16)/255;
                    let max = Math.max(r, g, b), min = Math.min(r, g, b), h, s, l = (max + min) / 2;
                    if (max == min) h = s = 0; else {
                        let d = max - min; s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                        switch (max) { case r: h = (g - b) / d + (g < b ? 6 : 0); break; case g: h = (b - r) / d + 2; break; case b: h = (r - g) / d + 4; break; } h *= 60;
                    }
                    return { h: Math.round(h), s: Math.round(s*100), l: Math.round(l*100), hex: hex.toUpperCase() };
                },
                hexToRgbVal: (hex) => {
                    let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                    return result ? {r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16)} : {r:0,g:0,b:0};
                },
                getContrast: (hex1, hex2) => {
                    const lum = (hex) => {
                        let {r,g,b} = App.utils.hexToRgbVal(hex);
                        const a = [r/255, g/255, b/255].map(v => v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4));
                        return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
                    };
                    const l1 = lum(hex1), l2 = lum(hex2); return (Math.max(l1, l2) + 0.05) / (Math.min(l1, l2) + 0.05);
                },
                getContrastBadge: (r) => {
                    if(r >= 7) return `<span class="contrast-badge text-green-600 bg-green-50 border-green-200">AAA ${r.toFixed(1)}</span>`;
                    if(r >= 4.5) return `<span class="contrast-badge text-blue-600 bg-blue-50 border-blue-200">AA ${r.toFixed(1)}</span>`;
                    return `<span class="contrast-badge text-red-500 bg-red-50 border-red-200">Fail ${r.toFixed(1)}</span>`;
                },
                getTextColor: (bgColor) => { return App.utils.getContrast(bgColor, '#FFFFFF') > App.utils.getContrast(bgColor, '#000000') ? '#F8FAFC' : '#0F172A'; },
                copy: (text) => { navigator.clipboard.writeText(text).then(() => App.ui.showToast(`${text} copied!`)); },
                getColorDistance: (c1, c2) => {
                    return Math.sqrt(Math.pow(c1.r - c2.r, 2) + Math.pow(c1.g - c2.g, 2) + Math.pow(c1.b - c2.b, 2));
                },
                getColorName: (hex) => {
                    const rgb = App.utils.hexToRgbVal(hex);
                    let minDiff = Infinity;
                    let closest = "Color";
                    NAMED_COLORS.forEach(c => {
                        const diff = Math.sqrt(Math.pow(rgb.r - c.r, 2) + Math.pow(rgb.g - c.g, 2) + Math.pow(rgb.b - c.b, 2));
                        if(diff < minDiff) { minDiff = diff; closest = c.n; }
                    });
                    return closest;
                },
                playSound: () => {
                    if (!App.state.soundEnabled) return;
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(400, ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.15);
                    gain.gain.setValueAtTime(0.05, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.15);
                }
            },
            logic: {
                init: () => {
                    if (localStorage.getItem('chromazen_dark') === 'true' || (!('chromazen_dark' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                        App.state.darkMode = true; document.body.classList.add('dark');
                    }
                    App.ui.renderPresets(); App.ui.renderLibrary(); App.ui.initHarmonyDropdown(); App.logic.setMode(3); App.logic.generate(false);
                    document.body.onkeyup = (e) => {
                        if(document.activeElement.tagName === 'INPUT') return;
                        if(e.key === ' ' || e.code === 'Space') { e.preventDefault(); App.logic.generate(true, e); }
                        if((e.ctrlKey||e.metaKey) && e.key === 'z') App.logic.undo();
                        if((e.ctrlKey||e.metaKey) && e.key === 'y') App.logic.redo();
                        if(e.key === '?') App.ui.showShortcuts();
                        if(['1','2','3','4','5'].includes(e.key)) App.logic.toggleLock(parseInt(e.key)-1);
                    };
                    window.onclick = (e) => {
                        if (!e.target.closest('#harmony-dropdown')) document.getElementById('harmony-items').classList.add('select-hide');
                        document.getElementById('export-menu').classList.add('hidden');
                    };
                    window.addEventListener('paste', (e) => {
                        if (e.clipboardData && e.clipboardData.items) {
                            for (let i = 0; i < e.clipboardData.items.length; i++) {
                                if (e.clipboardData.items[i].type.indexOf('image') !== -1) {
                                    const blob = e.clipboardData.items[i].getAsFile();
                                    App.logic.extractFromImage(blob);
                                    break;
                                }
                            }
                        }
                    });
                },
                setMode: (n, regenerate = true) => { 
                    if(regenerate) App.logic.saveState();
                    App.state.mode = n;
                    document.querySelectorAll('.mode-btn').forEach(b => {
                        b.classList.remove('bg-white','dark:bg-dark-surface','text-gray-900','dark:text-white','shadow-sm');
                        b.classList.add('text-gray-500','dark:text-gray-400');
                        if(parseInt(b.dataset.mode) === n) {
                            b.classList.add('bg-white','dark:bg-dark-surface','text-gray-900','dark:text-white','shadow-sm');
                            b.classList.remove('text-gray-500','dark:text-gray-400');
                        }
                    });
                    if(regenerate) App.logic.generate(false);
                    else App.ui.render(); 
                },
                generate: (pushHistory = true, e) => {
                    const isSmart = e && e.shiftKey;
                    if(pushHistory) App.logic.saveState();
                    App.state.colorOffset = 0;
                    App.utils.playSound();
                    const btn = document.getElementById('btn-generate');
                    if(btn) { btn.classList.remove('btn-pop'); void btn.offsetWidth; btn.classList.add('btn-pop'); }
                    
                    let newColors = [...App.state.colors];
                    while(newColors.length < 5) newColors.push(null);
                    let base = (App.state.locked[0] && newColors[0]) ? newColors[0] : App.logic.getRandomColor();
                    
                    if (!isSmart) newColors[0] = base; 

                    const spread = App.state.variability * 0.6; 
                    const rule = App.state.harmony;

                    for(let i=0; i<App.state.mode; i++) {
                        if(App.state.locked[i] && newColors[i]) continue;
                        
                        let h, s, l;
                        
                        if (isSmart && newColors[i]) {
                            h = Math.floor(Math.random() * 360); s = newColors[i].s; l = newColors[i].l;
                        } else {
                            if (i === 0) {
                                let rc = App.logic.getRandomColor();
                                h = rc.h; s = rc.s; l = rc.l;
                            } else {
                                let b = newColors[0];
                                h = b.h; s = b.s; l = b.l;
                                
                                if (rule === 'analogous') h += spread * i;
                                else if (rule === 'monochromatic') {
                                    let lStep = (90 - b.l) / (App.state.mode); 
                                    if(b.l > 50) l = b.l - (i * 12); // Darken if light
                                    else l = b.l + (i * 12); // Lighten if dark
                                    l = Math.max(5, Math.min(95, l));
                                    s = Math.max(0, s - (i*5));
                                } 
                                else if (rule === 'complementary') h += 180 + ((Math.random()-0.5)*spread);
                                else if (rule === 'triadic') h += 120 * i + ((Math.random()-0.5)*spread/2);
                                else { h += (spread + 10) * i; let rc = App.logic.getRandomColor(); s = rc.s; l = rc.l; }
                                
                                if(rule !== 'random') {
                                    const p = App.logic.getPresetConstraints();
                                    if (rule === 'monochromatic') {
                                        if(p.sMax > 0) s = Math.max(p.sMin, Math.min(p.sMax, s));
                                    } else {
                                        s = Math.max(p.sMin, Math.min(p.sMax, s + (Math.random()-0.5)*20));
                                        l = Math.max(p.lMin, Math.min(p.lMax, l + (Math.random()-0.5)*20));
                                    }
                                }
                            }
                        }
                        newColors[i] = { h, s, l, hex: App.utils.hslToHex(h,s,l) };
                    }
                    App.state.colors = newColors.slice(0, App.state.mode);
                    App.ui.render();
                    if(pushHistory) App.ui.addToHistory();
                    if(isSmart) App.ui.showToast("Smart Shuffle: Tones kept, Hues changed");
                },
                remix: () => {
                    App.state.colorOffset = (App.state.colorOffset + 1) % App.state.mode;
                    App.ui.render();
                },
                togglePreset: (name) => {
                    if (App.state.preset === name) { App.state.preset = 'none'; App.ui.showToast('Preset cleared'); } 
                    else { App.state.preset = name; }
                    App.ui.renderPresets(); App.logic.generate(); 
                },
                selectHarmony: (val, text) => {
                    App.state.harmony = val;
                    document.getElementById('selected-harmony').innerText = text;
                },
                getRandomColor: () => {
                    const p = App.logic.getPresetConstraints();
                    const h = p.hRange ? p.hRange[0] + Math.random()*(p.hRange[1]-p.hRange[0]) : Math.floor(Math.random()*360);
                    const s = p.sMin + Math.random()*(p.sMax-p.sMin);
                    const l = p.lMin + Math.random()*(p.lMax-p.lMin);
                    return { h, s, l, hex: App.utils.hslToHex(h,s,l) };
                },
                getPresetConstraints: () => {
                    const sets = {
                        pastel: { sMin: 40, sMax: 90, lMin: 75, lMax: 95 }, vivid: { sMin: 70, sMax: 100, lMin: 40, lMax: 65 },
                        dark: { sMin: 20, sMax: 60, lMin: 10, lMax: 30 }, warm: { sMin: 50, sMax: 90, lMin: 40, lMax: 80, hRange: [0, 60] },
                        nature: { sMin: 20, sMax: 60, lMin: 30, lMax: 70, hRange: [70, 160] }, neon: { sMin: 90, sMax: 100, lMin: 50, lMax: 60 },
                        retro: { sMin: 30, sMax: 60, lMin: 50, lMax: 80, hRange: [20, 50] }, corporate: { sMin: 10, sMax: 40, lMin: 20, lMax: 50, hRange: [200, 240] },
                        luxury: { sMin: 20, sMax: 60, lMin: 10, lMax: 40, hRange: [30, 60] }, wedding: { sMin: 10, sMax: 40, lMin: 40, lMax: 98 }, 
                        grayscale: { sMin: 0, sMax: 0, lMin: 10, lMax: 90 }, cyberpunk: { sMin: 80, sMax: 100, lMin: 40, lMax: 70 },
                        none: { sMin: 20, sMax: 95, lMin: 10, lMax: 90 }
                    };
                    return sets[App.state.preset] || sets.none;
                },
                getInfoText: (key) => {
                    const map = {
                        'vivid': 'High saturation, energetic', 'pastel': 'Soft, soothing light colors', 'dark': 'Sophisticated dark themes',
                        'warm': 'Cozy reds, oranges, yellows', 'nature': 'Earth tones and greens', 'neon': 'Cyberpunk/Nightlife vibes',
                        'retro': 'Vintage, muted nostalgia', 'corporate': 'Trustworthy blues and greys', 'luxury': 'Gold, black, deep tones',
                        'wedding': 'Romantic whites with elegant deep tones', 'grayscale': 'Monochromatic ink/wireframe', 'cyberpunk': 'High contrast neon dark',
                        'spread': 'Controls color distance', 'harmony': 'Color theory rules', 'imagematch': 'Extract from image (Ctrl+V)',
                        'random': 'Completely random hues', 'analogous': 'Colors adjacent on the color wheel', 'monochromatic': 'Variations of a single hue',
                        'complementary': 'Opposite colors on the wheel', 'triadic': 'Three colors equally spaced'
                    };
                    return map[key] || 'Hover over controls for details.';
                },
                toggleLock: (idx) => { if(idx >= App.state.mode) return; App.state.locked[idx] = !App.state.locked[idx]; App.ui.render(); },
                saveState: () => {
                    const snap = JSON.stringify({ colors: App.state.colors, mode: App.state.mode, locked: App.state.locked });
                    if(App.state.undoStack.length === 0 || JSON.stringify(App.state.undoStack[App.state.undoStack.length-1]) !== snap) {
                        App.state.undoStack.push(JSON.parse(snap)); if(App.state.undoStack.length > 20) App.state.undoStack.shift();
                    } App.state.redoStack = [];
                },
                undo: () => {
                    if(App.state.undoStack.length === 0) return;
                    App.state.redoStack.push({ colors: App.state.colors, mode: App.state.mode, locked: App.state.locked });
                    const prev = App.state.undoStack.pop();
                    App.state.colors = prev.colors; App.state.mode = prev.mode; App.state.locked = prev.locked;
                    App.logic.setMode(prev.mode, false); 
                },
                redo: () => {
                    if(App.state.redoStack.length === 0) return;
                    App.logic.saveState();
                    const next = App.state.redoStack.pop();
                    App.state.colors = next.colors; App.state.mode = next.mode; App.state.locked = next.locked;
                    App.logic.setMode(next.mode, false); 
                },
                savePalette: () => {
                    App.state.library.unshift({ colors: App.state.colors.map(c => c.hex), date: new Date().toLocaleDateString() });
                    localStorage.setItem('chromazen_library', JSON.stringify(App.state.library));
                    if(App.state.activeTab === 'library') App.ui.renderLibrary();
                    App.ui.showToast('Palette saved to Library'); App.ui.switchSidebarTab('library');
                },
                deleteSaved: (idx) => {
                    App.state.library.splice(idx, 1); localStorage.setItem('chromazen_library', JSON.stringify(App.state.library)); App.ui.renderLibrary();
                },
                loadSaved: (idx) => {
                    App.logic.saveState();
                    const saved = App.state.library[idx];
                    App.state.colors = saved.colors.map(hex => App.utils.hexToHsl(hex));
                    App.logic.setMode(saved.colors.length, false); 
                },
                extractFromImage: (file) => {
                    if(!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                            const w = 150, h = 150 * (img.height/img.width); canvas.width = w; canvas.height = h;
                            ctx.drawImage(img, 0, 0, w, h);
                            const data = ctx.getImageData(0,0,w,h).data;
                            const colors = []; 
                            const threshold = 60; 
                            for(let i=0; i<1000; i++) { 
                                const offset = Math.floor(Math.random() * (data.length / 4)) * 4;
                                const r=data[offset], g=data[offset+1], b=data[offset+2];
                                const currentRgb = {r, g, b};
                                let distinct = true;
                                for(let c of colors) {
                                    if(App.utils.getColorDistance(currentRgb, c.rgb) < threshold) { distinct = false; break; }
                                }
                                if(distinct) {
                                    const hex = "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
                                    colors.push({ ...App.utils.hexToHsl(hex), rgb: currentRgb });
                                    if(colors.length >= App.state.mode) break;
                                }
                            }
                            const finalColors = colors.map(c => ({h:c.h, s:c.s, l:c.l, hex:c.hex}));
                            App.logic.saveState();
                            App.state.colors = finalColors;
                            while(App.state.colors.length < App.state.mode) App.state.colors.push(App.logic.getRandomColor());
                            App.ui.render(); App.ui.addToHistory(); App.ui.showToast('Smart extracted distinct colors');
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                },
                clearHistory: () => { 
                    if(App.state.activeTab === 'history') {
                        App.state.history = []; 
                        App.ui.renderHistory();
                    } else {
                        App.state.history = [];
                        App.ui.showToast("History Cleared");
                    }
                },
                handleDragStart: (e, idx) => {
                    e.dataTransfer.setData('text/plain', idx);
                    e.dataTransfer.effectAllowed = 'move';
                    e.target.classList.add('panel-dragging');
                },
                handleDrop: (e, toIndex) => {
                    e.preventDefault();
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    if (fromIndex === toIndex) return;
                    App.logic.saveState();
                    const cols = [...App.state.colors];
                    const locks = [...App.state.locked];
                    // Swap
                    [cols[fromIndex], cols[toIndex]] = [cols[toIndex], cols[fromIndex]];
                    [locks[fromIndex], locks[toIndex]] = [locks[toIndex], locks[fromIndex]];
                    App.state.colors = cols;
                    App.state.locked = locks;
                    App.ui.render();
                }
            },
            ui: {
                setViewMode: (mode) => {
                    App.state.viewMode = mode;
                    document.querySelectorAll('.view-btn').forEach(b => {
                        b.classList.remove('bg-white','dark:bg-dark-surface','text-gray-900','dark:text-white','shadow-sm');
                        b.classList.add('text-gray-500','dark:text-gray-400');
                    });
                    document.getElementById(`view-${mode}`).classList.add('bg-white','dark:bg-dark-surface','text-gray-900','dark:text-white','shadow-sm');
                    document.getElementById(`view-${mode}`).classList.remove('text-gray-500','dark:text-gray-400');
                    
                    const views = ['palette','gradient','mockup','typography'];
                    views.forEach(v => {
                        const el = document.getElementById(`view-${v}-content`);
                        if(v === mode) el.classList.remove('hidden'); else el.classList.add('hidden');
                    });
                    App.ui.render();
                },
                toggleSidebar: () => {
                    App.state.sidebarOpen = !App.state.sidebarOpen;
                    const sb = document.getElementById('sidebar');
                    if(App.state.sidebarOpen) sb.classList.remove('sidebar-closed');
                    else sb.classList.add('sidebar-closed');
                },
                toggleSound: () => {
                    App.state.soundEnabled = !App.state.soundEnabled;
                    const btn = document.getElementById('btn-sound');
                    btn.innerHTML = App.state.soundEnabled 
                        ? '<i data-lucide="volume-2" class="w-5 h-5"></i>' 
                        : '<i data-lucide="volume-x" class="w-5 h-5"></i>';
                    lucide.createIcons();
                    App.ui.showToast(App.state.soundEnabled ? 'Sound On' : 'Sound Off');
                },
                toggleColorBlindness: () => {
                    const modes = ['normal', 'protanopia', 'deuteranopia', 'tritanopia', 'achromatopsia'];
                    App.state.blindnessMode = (App.state.blindnessMode + 1) % modes.length;
                    const mode = modes[App.state.blindnessMode];
                    
                    const main = document.getElementById('app-main');
                    main.classList.remove('filter-protanopia', 'filter-deuteranopia', 'filter-tritanopia', 'filter-achromatopsia');
                    if(mode !== 'normal') main.classList.add(`filter-${mode}`);
                    
                    const indicator = document.getElementById('blindness-indicator');
                    if(mode !== 'normal') indicator.classList.remove('hidden');
                    else indicator.classList.add('hidden');
                    
                    const labels = ['Normal View', 'Protanopia (Red-Blind)', 'Deuteranopia (Green-Blind)', 'Tritanopia (Blue-Blind)', 'Achromatopsia (Monochrome)'];
                    App.ui.showToast(`Simulating: ${labels[App.state.blindnessMode]}`);
                },
                render: () => {
                    const mode = App.state.viewMode;
                    if(mode === 'palette') App.ui.renderPalette();
                    if(mode === 'gradient') App.ui.renderGradient();
                    if(mode === 'mockup') App.ui.renderMockup();
                    if(mode === 'typography') App.ui.renderTypography();
                    
                    App.ui.updateRemixButtons();
                    lucide.createIcons();
                },
                updateRemixButtons: () => {
                    const c = App.state.colors; if(!c.length) return;
                    const bg = c[0].hex, txt = App.utils.getTextColor(bg), border = c[1] ? c[1].hex : bg;
                    const styleBtn = (btn) => { if(!btn) return; btn.style.backgroundColor = bg; btn.style.color = txt; btn.style.borderColor = border; };
                    styleBtn(document.getElementById('btn-remix-mockup'));
                    styleBtn(document.getElementById('btn-remix-typo'));
                },
                renderPalette: () => {
                    const container = document.getElementById('view-palette-content'); container.innerHTML = '';
                    App.state.colors.forEach((c, i) => {
                        const txt = App.utils.getTextColor(c.hex); const isLocked = App.state.locked[i];
                        const name = App.utils.getColorName(c.hex);
                        const nextColor = App.state.colors[i+1];
                        const contrastBadge = nextColor ? App.utils.getContrastBadge(App.utils.getContrast(c.hex, nextColor.hex)) : '';

                        const div = document.createElement('div');
                        div.draggable = true;
                        div.className = `color-panel flex-1 relative flex flex-col justify-center items-center group cursor-pointer p-4 ${isLocked?'panel-locked':''}`;
                        div.style.backgroundColor = c.hex; div.style.color = txt;
                        
                        div.ondragstart = (e) => App.logic.handleDragStart(e, i);
                        div.ondragover = (e) => e.preventDefault();
                        div.ondrop = (e) => App.logic.handleDrop(e, i);
                        div.ondragend = (e) => e.target.classList.remove('panel-dragging');

                        div.innerHTML = `
                            <div class="absolute top-6 right-6"><button onclick="event.stopPropagation(); App.logic.toggleLock(${i})" class="p-2 rounded-full transition-all ${isLocked ? 'bg-black/20 text-white' : 'opacity-0 group-hover:opacity-100 hover:bg-black/10'}"><i data-lucide="${isLocked?'lock':'unlock'}" class="w-5 h-5"></i></button></div>
                            <h2 onclick="event.stopPropagation(); App.ui.openTuneModal(${i})" class="text-3xl font-black uppercase font-mono hover:opacity-70 transition-opacity" title="Edit">${c.hex}</h2>
                            <p class="text-xs opacity-60 font-medium tracking-widest mt-1 text-center">${name}</p>
                            <button onclick="event.stopPropagation(); App.utils.copy('${c.hex}')" class="absolute bottom-10 opacity-0 group-hover:opacity-100 transition-opacity px-4 py-2 rounded-full border border-current bg-white/10 backdrop-blur-sm text-xs font-bold flex items-center gap-2"><i data-lucide="copy" class="w-3 h-3"></i> COPY</button>
                            ${contrastBadge}
                        `;
                        container.appendChild(div);
                    });
                },
                renderGradient: () => {
                    const angle = App.state.gradientAngle || 90;
                    const css = `linear-gradient(${angle}deg, ${App.state.colors.map(c=>c.hex).join(', ')})`;
                    document.getElementById('gradient-box').style.background = css;
                    document.getElementById('gradient-css').innerText = css;
                },
                updateGradientAngle: (val) => {
                    App.state.gradientAngle = val;
                    document.getElementById('grad-angle-val').innerText = val + 'Â°';
                    App.ui.renderGradient();
                },
                renderMockup: () => {
                    const rawColors = App.state.colors;
                    const offset = App.state.colorOffset;
                    const c = rawColors.map((_, i) => rawColors[(i + offset) % rawColors.length]);
                    const bg = c[0].hex, txt = App.utils.getTextColor(bg), acc = c[1] ? c[1].hex : bg;
                    const accTxt = App.utils.getTextColor(acc);
                    const el = (id) => document.getElementById(id);
                    el('mock-container').style.backgroundColor = bg; el('mock-hero').style.backgroundColor = bg; el('mock-hero').style.color = txt;
                    el('mock-badge').style.backgroundColor = txt + '15'; el('mock-badge').style.color = txt;
                    el('mock-title').style.background = `linear-gradient(to right, ${txt}, ${acc})`;
                    el('mock-title').style.webkitBackgroundClip = 'text';
                    el('mock-title').style.webkitTextFillColor = 'transparent';
                    el('mock-subtitle').style.color = txt;
                    el('mock-btn-primary').style.backgroundColor = acc; el('mock-btn-primary').style.color = accTxt;
                    el('mock-btn-secondary').style.borderColor = txt + '40'; el('mock-btn-secondary').style.color = txt;
                    const s1 = c[2]?.hex || acc; const s2 = c[3]?.hex || bg; 
                    el('mock-shapes').innerHTML = `<svg viewBox="0 0 400 400" fill="none" style="transform: rotate(-15deg);"><circle cx="300" cy="100" r="80" fill="${s1}" fill-opacity="0.2" /><rect x="200" y="200" width="120" height="120" rx="20" fill="${s2}" fill-opacity="0.2" /></svg>`;
                    const glassStyle = `background: ${txt}08; backdrop-filter: blur(12px); border: 1px solid ${txt}10; color: ${txt};`;
                    el('mock-card-1').setAttribute('style', glassStyle);
                    el('mock-card-2').setAttribute('style', glassStyle);
                    el('mock-card-3').style.background = `linear-gradient(135deg, ${c[2]?.hex}, ${c[3]?.hex})`;
                    el('mock-card-3').style.color = App.utils.getTextColor(c[2]?.hex);
                    el('mock-footer').style.color = txt;
                },
                renderTypography: () => {
                    const rawColors = App.state.colors;
                    const offset = App.state.colorOffset;
                    const c = rawColors.map((_, i) => rawColors[(i + offset) % rawColors.length]);
                    const container = document.getElementById('typo-inject-area');
                    const getColor = (i) => c[i % c.length].hex;
                    const fontClass = App.state.typoFont === 'serif' ? 'serif-font' : App.state.typoFont === 'mono' ? 'mono-font' : 'font-sans';
                    container.className = fontClass + " bg-white dark:bg-dark-surface p-16 rounded-xl shadow-sm min-h-[800px]";
                    container.innerHTML = `
                        <article class="max-w-3xl mx-auto">
                            <div class="flex items-center justify-between border-b-2 pb-8 mb-12" style="border-color:${getColor(0)}">
                                <span class="text-sm font-bold tracking-[0.2em] uppercase" style="color:${getColor(2)}">Brand Guideline</span>
                                <span class="text-sm font-mono opacity-60" style="color:${getColor(0)}">v1.0</span>
                            </div>
                            <h1 class="text-7xl font-black mb-8 leading-tight" style="color:${getColor(0)}">Visual<br>Harmony.</h1>
                            <div class="grid md:grid-cols-12 gap-8 mb-16">
                                <div class="md:col-span-8">
                                    <p class="text-2xl font-medium leading-relaxed mb-6" style="color:${getColor(1)}">Color creates emotion. It is the silent ambassador of your brand.</p>
                                    <p class="text-lg opacity-70 leading-relaxed" style="color:${getColor(0)}">A well-chosen palette not only looks good but also enhances usability and user experience.</p>
                                </div>
                                <div class="md:col-span-4 p-6 rounded-lg" style="background:${getColor(3)}15">
                                    <span class="block text-xs font-bold uppercase mb-2 opacity-50" style="color:${getColor(0)}">Accent</span>
                                    <div class="h-2 w-12 mb-4" style="background:${getColor(3)}"></div>
                                    <p class="text-sm font-mono" style="color:${getColor(0)}">${getColor(3)}</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-0 mb-16 rounded-xl overflow-hidden shadow-lg">
                                ${c.map(col => `<div class="h-32 flex items-end p-4" style="background:${col.hex}"><span class="text-xs font-mono bg-white/20 px-2 py-1 rounded backdrop-blur-sm" style="color:${App.utils.getTextColor(col.hex)}">${col.hex}</span></div>`).join('')}
                            </div>
                            <div class="p-10 rounded-xl mb-12" style="background:${getColor(4)}; color:${App.utils.getTextColor(getColor(4))}">
                                <h3 class="text-2xl font-bold mb-4">"Design is intelligence made visible."</h3>
                                <div class="flex gap-4 mt-6">
                                    <button class="px-6 py-3 rounded-lg font-bold bg-black/20 hover:bg-black/30 transition-colors">Primary Action</button>
                                    <button class="px-6 py-3 rounded-lg font-bold border-2 border-current opacity-70 hover:opacity-100 transition-opacity">Secondary</button>
                                </div>
                            </div>
                        </article>
                    `;
                },
                initHarmonyDropdown: () => {
                    const dd = document.getElementById('harmony-items');
                    const opts = [
                        {v:'random', t:'ðŸŽ² Random Shuffle', i:'ì™„ì „ ë¬´ìž‘ìœ„ ë°°ìƒ‰'},
                        {v:'analogous', t:'ðŸŽ¨ Analogous', i:'ìœ ì‚¬ìƒ‰: ì¸ì ‘í•œ ìƒ‰ìƒë“¤ì˜ ì¡°í™”'},
                        {v:'monochromatic', t:'ðŸŒ— Monochromatic', i:'ë‹¨ìƒ‰: ëª…ë„ ì°¨ì´ë¥¼ ì´ìš©í•œ í†¤ì˜¨í†¤'},
                        {v:'complementary', t:'â˜¯ï¸ Complementary', i:'ë³´ìƒ‰: ì„œë¡œ ë°˜ëŒ€ë˜ëŠ” ê°•ë ¬í•œ ëŒ€ë¹„'},
                        {v:'triadic', t:'ðŸ”º Triadic', i:'ì‚¼ê°ì¡°í™”: ê· í˜• ìž¡ížŒ 3ìƒ‰ ë°°í•©'}
                    ];
                    dd.innerHTML = opts.map(o => `
                        <div onclick="App.logic.selectHarmony('${o.v}', '${o.t}')" 
                             onmouseenter="App.ui.updateInfo('${o.i}')" 
                             onmouseleave="App.ui.resetInfo()">
                            ${o.t}
                        </div>
                    `).join('');
                },
                toggleDropdown: (e) => {
                    e.stopPropagation();
                    document.getElementById('harmony-items').classList.toggle('select-hide');
                    document.querySelector('.select-selected i').classList.toggle('select-arrow-active');
                },
                renderHistory: () => {
                    const container = document.getElementById('history-container'); container.innerHTML = '';
                    if(App.state.history.length === 0) { container.innerHTML = '<p class="text-xs text-gray-400 col-span-4 text-center mt-4">History is empty.</p>'; return; }
                    App.state.history.forEach(palette => {
                        const div = document.createElement('div');
                        div.className = 'w-full aspect-square rounded-lg overflow-hidden cursor-pointer hover:ring-2 ring-indigo-500 transition-all flex flex-col border dark:border-gray-700';
                        div.onclick = () => { App.logic.saveState(); App.state.colors = palette.map(hex => App.utils.hexToHsl(hex)); App.logic.setMode(palette.length, false); };
                        palette.forEach(hex => { const d = document.createElement('div'); d.style.backgroundColor = hex; d.className = 'flex-1 w-full'; div.appendChild(d); });
                        container.appendChild(div);
                    });
                },
                addToHistory: () => {
                    const snap = App.state.colors.map(c => c.hex); App.state.history.unshift(snap);
                    if(App.state.history.length > 20) App.state.history.pop();
                    if(App.state.activeTab === 'history') App.ui.renderHistory();
                },
                renderPresets: () => {
                    const grid = document.getElementById('presets-grid');
                    const presets = ['vivid','pastel','dark','warm','nature','neon','retro','corporate','luxury','wedding', 'grayscale', 'cyberpunk'];
                    grid.innerHTML = presets.map(p => {
                        const isActive = App.state.preset === p;
                        const activeClass = isActive 
                            ? 'bg-gray-900 text-white dark:bg-gray-100 dark:text-black border-transparent shadow-md' 
                            : 'bg-gray-50 dark:bg-dark-bg border-gray-100 dark:border-dark-border text-gray-600 dark:text-gray-300 hover:border-gray-300';
                        return `
                        <button 
                            onmouseenter="App.ui.updateInfo(App.logic.getInfoText('${p}'))" 
                            onmouseleave="App.ui.resetInfo()"
                            onclick="App.logic.togglePreset('${p}')" 
                            class="py-2 px-3 rounded-lg border transition-all text-left flex items-center gap-2 ${activeClass}">
                            <span class="w-3 h-3 rounded-full bg-gradient-to-br from-gray-300 to-gray-500"></span><span class="text-xs font-medium capitalize">${p}</span>
                        </button>`;
                    }).join('');
                },
                renderLibrary: () => {
                    const container = document.getElementById('library-container');
                    if(App.state.library.length === 0) { container.innerHTML = '<p class="text-xs text-gray-400 text-center mt-8">No saved palettes.</p>'; return; }
                    container.innerHTML = App.state.library.map((item, idx) => `
                        <div class="bg-gray-50 dark:bg-dark-bg p-2 rounded-lg border border-gray-100 dark:border-dark-border flex items-center justify-between group">
                            <div class="flex-1 flex h-8 rounded overflow-hidden cursor-pointer mr-3" onclick="App.logic.loadSaved(${idx})">${item.colors.map(c => `<div style="background:${c}" class="flex-1 h-full"></div>`).join('')}</div>
                            <button onclick="App.logic.deleteSaved(${idx})" class="text-gray-400 hover:text-red-500 p-1"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>`).join('');
                },
                switchSidebarTab: (tab) => {
                    App.state.activeTab = tab;
                    const isPresets = tab === 'presets';
                    const isLibrary = tab === 'library';
                    const isHistory = tab === 'history';

                    document.getElementById('sidebar-presets').classList.toggle('hidden', !isPresets);
                    document.getElementById('sidebar-library').classList.toggle('hidden', !isLibrary);
                    document.getElementById('sidebar-history').classList.toggle('hidden', !isHistory);

                    const setTabStyle = (id, active) => {
                        const el = document.getElementById(id);
                        el.classList.toggle('border-transparent', !active);
                        el.classList.toggle('border-black', active);
                        el.classList.toggle('dark:border-white', active);
                        el.classList.toggle('text-black', active);
                        el.classList.toggle('dark:text-white', active);
                        el.classList.toggle('text-gray-400', !active);
                    };

                    setTabStyle('tab-presets', isPresets);
                    setTabStyle('tab-library', isLibrary);
                    setTabStyle('tab-history', isHistory);

                    if(isHistory) App.ui.renderHistory();
                },
                openTuneModal: (idx) => {
                    App.state.editingIndex = idx; const c = App.state.colors[idx];
                    const content = `<div class="bg-white dark:bg-dark-surface rounded-2xl shadow-2xl w-full max-w-sm p-6 transform scale-100 transition-transform">
                            <h3 class="font-bold text-lg mb-4 dark:text-white">Edit Color</h3>
                            <div class="w-full h-24 rounded-xl mb-4" style="background:${c.hex}" id="tune-preview"></div>
                            <div class="flex gap-2 mb-4"><span class="flex items-center justify-center w-10 bg-gray-100 dark:bg-dark-bg rounded-lg text-gray-500">#</span><input type="text" value="${c.hex.replace('#','')}" class="flex-1 bg-gray-50 dark:bg-dark-bg rounded-lg px-3 font-mono uppercase focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white" maxlength="6" oninput="App.ui.updateTuneHex(this.value)"></div>
                            <div class="space-y-4"><div><label class="text-xs font-bold text-gray-400">Saturation</label><input type="range" min="0" max="100" value="${c.s}" class="w-full" oninput="App.ui.updateTuneHsl('s', this.value)"></div><div><label class="text-xs font-bold text-gray-400">Lightness</label><input type="range" min="0" max="100" value="${c.l}" class="w-full" oninput="App.ui.updateTuneHsl('l', this.value)"></div></div>
                            <div class="flex justify-end gap-2 mt-6"><button onclick="App.ui.closeModal()" class="px-4 py-2 text-sm font-bold text-gray-500 hover:bg-gray-100 dark:hover:bg-dark-bg rounded-lg">Cancel</button><button onclick="App.ui.applyTune()" class="px-4 py-2 text-sm font-bold bg-black dark:bg-white text-white dark:text-black rounded-lg">Apply</button></div></div>`;
                    App.ui.showModal(content);
                },
                updateTuneHsl: (type, val) => {
                    const c = App.state.colors[App.state.editingIndex];
                    if(type === 's') c.s = parseInt(val); if(type === 'l') c.l = parseInt(val);
                    c.hex = App.utils.hslToHex(c.h, c.s, c.l);
                    document.getElementById('tune-preview').style.backgroundColor = c.hex;
                },
                updateTuneHex: (val) => {
                    if(val.length === 6) {
                        const hsl = App.utils.hexToHsl('#'+val); App.state.colors[App.state.editingIndex] = hsl;
                        document.getElementById('tune-preview').style.backgroundColor = '#' + val;
                    }
                },
                applyTune: () => { App.ui.render(); App.ui.closeModal(); },
                showModal: (html) => {
                    const container = document.getElementById('modal-container'); container.innerHTML = html; container.classList.remove('hidden'); requestAnimationFrame(() => container.classList.remove('opacity-0'));
                },
                showShortcuts: () => {
                    const content = `
                        <div class="bg-white dark:bg-dark-surface rounded-2xl shadow-2xl w-full max-w-sm p-6 transform scale-100 transition-transform">
                            <h3 class="font-bold text-lg mb-4 dark:text-white flex items-center gap-2"><i data-lucide="keyboard" class="w-5 h-5"></i> Shortcuts</h3>
                            <div class="space-y-3 text-sm text-gray-600 dark:text-gray-300">
                                <div class="flex justify-between"><span>Generate</span> <span class="font-mono bg-gray-100 dark:bg-dark-bg px-2 py-0.5 rounded">Space</span></div>
                                <div class="flex justify-between"><span>Smart Shuffle</span> <span class="font-mono bg-gray-100 dark:bg-dark-bg px-2 py-0.5 rounded">Shift + Click</span></div>
                                <div class="flex justify-between"><span>Undo</span> <span class="font-mono bg-gray-100 dark:bg-dark-bg px-2 py-0.5 rounded">Ctrl + Z</span></div>
                                <div class="flex justify-between"><span>Redo</span> <span class="font-mono bg-gray-100 dark:bg-dark-bg px-2 py-0.5 rounded">Ctrl + Y</span></div>
                                <div class="flex justify-between"><span>Lock 1-5</span> <span class="font-mono bg-gray-100 dark:bg-dark-bg px-2 py-0.5 rounded">1 ... 5</span></div>
                                <div class="flex justify-between"><span>Toggle Sidebar</span> <span class="font-mono bg-gray-100 dark:bg-dark-bg px-2 py-0.5 rounded">Menu Btn</span></div>
                            </div>
                            <div class="mt-6 flex justify-end">
                                <button onclick="App.ui.closeModal()" class="px-4 py-2 text-sm font-bold bg-black dark:bg-white text-white dark:text-black rounded-lg">Got it</button>
                            </div>
                        </div>
                    `;
                    App.ui.showModal(content);
                },
                closeModal: () => {
                    const container = document.getElementById('modal-container'); container.classList.add('opacity-0'); setTimeout(() => container.classList.add('hidden'), 200);
                },
                toggleExportMenu: (e) => { e.stopPropagation(); document.getElementById('export-menu').classList.toggle('hidden'); },
                showToast: (msg) => {
                    const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-4'); setTimeout(() => t.classList.add('opacity-0', 'pointer-events-none', 'translate-y-4'), 2500);
                },
                updateSliderLabel: (val) => {
                    App.state.variability = parseInt(val); document.getElementById('variability-label').innerText = val < 20 ? 'Tight' : val > 70 ? 'Wide' : 'Medium';
                },
                toggleGrain: () => { // Deprecated but kept for compatibility logic removal
                    // Grain removed
                },
                toggleDarkMode: () => {
                    App.state.darkMode = !App.state.darkMode; document.body.classList.toggle('dark'); localStorage.setItem('chromazen_dark', App.state.darkMode);
                },
                updateInfo: (text) => { document.getElementById('info-text').innerText = text; },
                resetInfo: () => { document.getElementById('info-text').innerText = 'Hover over controls or presets for details.'; },
                setFont: (font) => {
                    App.state.typoFont = font;
                    document.getElementById('font-sans').className = `px-3 py-1.5 text-xs font-bold rounded-md hover:bg-gray-100 dark:hover:bg-dark-bg font-sans ${font === 'sans' ? 'bg-black text-white dark:bg-white dark:text-black' : ''}`;
                    document.getElementById('font-serif').className = `px-3 py-1.5 text-xs font-bold rounded-md hover:bg-gray-100 dark:hover:bg-dark-bg font-serif ${font === 'serif' ? 'bg-black text-white dark:bg-white dark:text-black' : ''}`;
                    document.getElementById('font-mono').className = `px-3 py-1.5 text-xs font-bold rounded-md hover:bg-gray-100 dark:hover:bg-dark-bg font-mono ${font === 'mono' ? 'bg-black text-white dark:bg-white dark:text-black' : ''}`;
                    App.ui.renderTypography();
                },
                toggleSound: () => {
                    App.state.soundEnabled = !App.state.soundEnabled;
                    const btn = document.getElementById('btn-sound');
                    btn.innerHTML = App.state.soundEnabled 
                        ? '<i data-lucide="volume-2" class="w-5 h-5"></i>' 
                        : '<i data-lucide="volume-x" class="w-5 h-5"></i>';
                    lucide.createIcons();
                    App.ui.showToast(App.state.soundEnabled ? 'Sound On' : 'Sound Off');
                },
                toggleColorBlindness: () => {
                    const modes = ['normal', 'protanopia', 'deuteranopia', 'tritanopia', 'achromatopsia'];
                    App.state.blindnessMode = (App.state.blindnessMode + 1) % modes.length;
                    const mode = modes[App.state.blindnessMode];
                    
                    const main = document.getElementById('app-main');
                    main.classList.remove('filter-protanopia', 'filter-deuteranopia', 'filter-tritanopia', 'filter-achromatopsia');
                    if(mode !== 'normal') main.classList.add(`filter-${mode}`);
                    
                    const indicator = document.getElementById('blindness-indicator');
                    if(mode !== 'normal') indicator.classList.remove('hidden');
                    else indicator.classList.add('hidden');
                    
                    const labels = ['Normal View', 'Protanopia (Red-Blind)', 'Deuteranopia (Green-Blind)', 'Tritanopia (Blue-Blind)', 'Achromatopsia (Monochrome)'];
                    App.ui.showToast(`Simulating: ${labels[App.state.blindnessMode]}`);
                },
            },
            exports: {
                css: () => { const css = `:root {\n${App.state.colors.map((c,i) => `  --color-${i===0?'primary':i===1?'secondary':i===2?'accent':i+1}: ${c.hex};`).join('\n')}\n}`; App.utils.copy(css); },
                tailwind: () => { const config = `colors: {\n${App.state.colors.map((c,i) => `  '${i===0?'primary':i===1?'secondary':i===2?'accent':i+1}': '${c.hex}',`).join('\n')}\n}`; App.utils.copy(config); },
                ase: () => { App.ui.showToast('ASE download started...'); },
                image: () => {
                    const area = document.getElementById('export-palette-area'); const code = document.getElementById('export-codes');
                    area.innerHTML = App.state.colors.map(c => `<div style="background:${c.hex}" class="flex-1 h-full"></div>`).join('');
                    code.innerHTML = App.state.colors.map(c => `<span>${c.hex}</span>`).join('');
                    html2canvas(document.getElementById('export-container')).then(canvas => {
                        const a = document.createElement('a'); a.download = 'chromazen-palette.png'; a.href = canvas.toDataURL(); a.click();
                    });
                }
            }
        };
        App.logic.init();
        App.ui.setFont('sans'); // Init font UI
    </script>
</body>
</html>
